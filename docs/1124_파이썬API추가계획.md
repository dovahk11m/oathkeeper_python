# Python AI ì„œë²„ ì‹ ê·œ API ì¶”ê°€ ì‘ì—… ê³„íšì„œ

**ì‘ì„±ì¼:** 2025-11-24  
**ì‘ì„±ì:** AI Assistant  
**ì°¸ì¡° ë¬¸ì„œ:** [PYTHON_API_REQ.md](file:///c:/workspace/oathkeeper_python/docs/PYTHON_API_REQ.md)

---

## ğŸ“‹ ëª©ì°¨

1. [í”„ë¡œì íŠ¸ í˜„í™© ë¶„ì„](#1-í”„ë¡œì íŠ¸-í˜„í™©-ë¶„ì„)
2. [ìš”êµ¬ì‚¬í•­ ìš”ì•½](#2-ìš”êµ¬ì‚¬í•­-ìš”ì•½)
3. [êµ¬í˜„ ê³„íš](#3-êµ¬í˜„-ê³„íš)
4. [íŒŒì¼ ìˆ˜ì • ìƒì„¸](#4-íŒŒì¼-ìˆ˜ì •-ìƒì„¸)
5. [í…ŒìŠ¤íŠ¸ ê³„íš](#5-í…ŒìŠ¤íŠ¸-ê³„íš)
6. [ìœ„í—˜ ìš”ì†Œ ë° ê³ ë ¤ì‚¬í•­](#6-ìœ„í—˜-ìš”ì†Œ-ë°-ê³ ë ¤ì‚¬í•­)

---

## 1. í”„ë¡œì íŠ¸ í˜„í™© ë¶„ì„

### 1.1 í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
oathkeeper_python/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # FastAPI ì•± ì§„ì…ì 
â”‚   â”œâ”€â”€ models.py               # Pydantic ëª¨ë¸ ì •ì˜
â”‚   â”œâ”€â”€ storage.py              # íŒŒì¼ I/O ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ metrics.py          # POST /metrics/analyze
â”‚   â”‚   â”œâ”€â”€ report.py           # GET/POST /metrics/report/{plan_id}/*
â”‚   â”‚   â””â”€â”€ llm.py              # POST /metrics/llm/generate
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ report_service.py   # ë¦¬í¬íŠ¸ ìƒì„± ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚       â”œâ”€â”€ llm_adapter.py      # LLM í†µí•© (ìŠ¤ì¼ˆë ˆí†¤)
â”‚       â””â”€â”€ llm_client.py       # LLM í´ë¼ì´ì–¸íŠ¸
â”œâ”€â”€ data/
â”‚   â””â”€â”€ plan_{id}/
â”‚       â””â”€â”€ metrics.jsonl       # í”Œëœë³„ ë©”íŠ¸ë¦­ ë°ì´í„°
â””â”€â”€ docs/
    â””â”€â”€ PYTHON_API_REQ.md       # ì‹ ê·œ API ìš”ì²­ ëª…ì„¸
```

### 1.2 ê¸°ì¡´ API ì—”ë“œí¬ì¸íŠ¸

| Method | Endpoint                         | ì„¤ëª…                             |
| ------ | -------------------------------- | -------------------------------- |
| POST   | `/metrics/analyze`               | ë‹¨ì¼ ë©”íŠ¸ë¦­ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„  |
| GET    | `/metrics/report/{plan_id}`      | ë‹¨ì¼ í”Œëœ ë¦¬í¬íŠ¸ ìƒì„±            |
| GET    | `/metrics/report/{plan_id}/text` | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ (ê¸°ë³¸)   |
| POST   | `/metrics/report/{plan_id}/text` | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ (ì»¤ìŠ¤í…€) |
| POST   | `/metrics/llm/generate`          | LLM í…ìŠ¤íŠ¸ ìƒì„± (ë²”ìš©)           |

### 1.3 ë°ì´í„° ì €ì¥ êµ¬ì¡°

- **ìœ„ì¹˜**: `data/plan_{id}/metrics.jsonl`
- **í˜•ì‹**: JSONL (JSON Lines) - ê° ì¤„ì´ í•˜ë‚˜ì˜ ë©”íŠ¸ë¦­ ë ˆì½”ë“œ
- **í•„ë“œ**:
  ```json
  {
    "plan_id": 1,
    "member_id": 123,
    "distance_km": 5.2,
    "travel_minutes": 25,
    "late_minutes": 0,
    "wait_minutes": 5,
    "created_at": "2025-11-24T12:41:23.154004Z"
  }
  ```

### 1.4 ê¸°ì¡´ ì½”ë“œ í’ˆì§ˆ í‰ê°€

âœ… **ì¥ì :**

- ëª…í™•í•œ ë ˆì´ì–´ ë¶„ë¦¬ (routers â†’ services â†’ storage)
- Pydanticì„ í™œìš©í•œ íƒ€ì… ì•ˆì „ì„±
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜ (ìµœê·¼ ë¦¬íŒ©í† ë§ ì™„ë£Œ)
- JSONL ê¸°ë°˜ ê°„ë‹¨í•œ ë°ì´í„° ì €ì¥ì†Œ

âš ï¸ **ì£¼ì˜ì‚¬í•­:**

- ìµœê·¼ ë¼ìš°íŒ… ì¶©ëŒ ìˆ˜ì • ì´ë ¥ ì¡´ì¬ ([ë¼ìš°íŒ…*ìˆ˜ì •*ì‘ì—…\_ë‚´ì—­.md](file:///c:/workspace/oathkeeper_python/ë¼ìš°íŒ…_ìˆ˜ì •_ì‘ì—…_ë‚´ì—­.md))
- ì‹ ê·œ API ì¶”ê°€ ì‹œ ë¼ìš°íŒ… ì¶©ëŒ ì¬ë°œ ë°©ì§€ í•„ìš”
- LLM í†µí•©ì´ ì•„ì§ ì™„ì „í•˜ì§€ ì•ŠìŒ (ìŠ¤ì¼ˆë ˆí†¤ ìƒíƒœ)

---

## 2. ìš”êµ¬ì‚¬í•­ ìš”ì•½

### 2.1 ì‹ ê·œ API #1: ê·¸ë£¹ ëˆ„ì  ë°ì´í„° ìš”ì•½

**Endpoint:** `POST /metrics/group/summary`

**ê¸°ëŠ¥:**

- ì—¬ëŸ¬ `plan_id`ì˜ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬ ê·¸ë£¹ ì „ì²´ í†µê³„ ê³„ì‚°
- ì´ ì•½ì† ìˆ˜, ì´/í‰ê·  ì´ë™ ê±°ë¦¬, ì´/í‰ê·  ì§€ê° ì‹œê°„ ë“± ì œê³µ

**ìš”ì²­ ì˜ˆì‹œ:**

```json
{
  "plan_ids": [1, 5, 12, 23]
}
```

**ì‘ë‹µ ì˜ˆì‹œ:**

```json
{
  "success": true,
  "data": {
    "group_summary": {
      "total_plans_analyzed": 4,
      "total_records": 128,
      "total_distance_km": 258.4,
      "avg_distance_per_plan_km": 64.6,
      "total_late_minutes": 45,
      "avg_late_minutes_per_plan": 11.25
    }
  },
  "warnings": ["plan_id '15' was not found."]
}
```

### 2.2 ì‹ ê·œ API #2: ê·¸ë£¹ ëˆ„ì  ë°ì´í„° ìì—°ì–´ ìš”ì•½

**Endpoint:** `POST /metrics/group/summary/text`

**ê¸°ëŠ¥:**

- API #1ì˜ í†µê³„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ LLMì„ ì‚¬ìš©í•˜ì—¬ ìì—°ì–´ ìš”ì•½ ìƒì„±
- ìŠ¤íƒ€ì¼, ë…¸íŠ¸ ë“± ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜µì…˜ ì§€ì›

**ìš”ì²­ ì˜ˆì‹œ:**

```json
{
  "plan_ids": [1, 5, 12, 23],
  "style": "ë°ì´í„° ë¶„ì„ê°€ì²˜ëŸ¼ ê°ê´€ì ì¸ í†¤ìœ¼ë¡œ",
  "notes": "ì§€ê° ë¹ˆë„ê°€ ë†’ì€ ê²½í–¥ì´ ìˆëŠ”ì§€ ë¶„ì„í•´ì£¼ì„¸ìš”."
}
```

**ì‘ë‹µ ì˜ˆì‹œ:**

```json
{
  "success": true,
  "data": "ë¶„ì„ëœ 4ê°œì˜ ì•½ì†ì— ë”°ë¥´ë©´, ì´ ê·¸ë£¹ì€ ì•½ì†ë‹¹ í‰ê·  64.6kmë¥¼ ì´ë™í–ˆìœ¼ë©°, í‰ê·  11.25ë¶„ì˜ ì§€ê° ì‹œê°„ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ì „ë°˜ì ìœ¼ë¡œ ì¥ê±°ë¦¬ ì´ë™ì´ ì¦ê³ , ì•½ì† ì‹œê°„ì„ ì¤€ìˆ˜í•˜ëŠ” ë° ì•½ê°„ì˜ ì–´ë ¤ì›€ì´ ìˆëŠ” ê²½í–¥ì„ ë³´ì…ë‹ˆë‹¤."
}
```

### 2.3 ì—ëŸ¬ ì²˜ë¦¬ ì •ì±…

| ìƒí™©                          | HTTP ìƒíƒœ                | ì‘ë‹µ í˜•ì‹                         |
| ----------------------------- | ------------------------ | --------------------------------- |
| ì¼ë¶€ plan_id ëˆ„ë½/ë°ì´í„° ì—†ìŒ | 200 OK                   | `success: true` + `warnings` ë°°ì—´ |
| ëª¨ë“  plan_id ë¬¸ì œ ìˆìŒ        | 409 Conflict             | `success: false` + ì—ëŸ¬ ë©”ì‹œì§€    |
| ì˜ëª»ëœ ìš”ì²­ í˜•ì‹              | 422 Unprocessable Entity | FastAPI ê¸°ë³¸ ì—ëŸ¬                 |

---

## 3. êµ¬í˜„ ê³„íš

### 3.1 ì‘ì—… ë‹¨ê³„

```mermaid
graph TD
    A[1. ëª¨ë¸ ì •ì˜] --> B[2. ì„œë¹„ìŠ¤ ë¡œì§ êµ¬í˜„]
    B --> C[3. ë¼ìš°í„° ì¶”ê°€]
    C --> D[4. í†µí•© í…ŒìŠ¤íŠ¸]
    D --> E[5. ë¬¸ì„œí™”]
```

### 3.2 êµ¬í˜„ ìš°ì„ ìˆœìœ„

1. **Phase 1: í•µì‹¬ ê¸°ëŠ¥** (í•„ìˆ˜)

   - [ ] Pydantic ëª¨ë¸ ì¶”ê°€ (`models.py`)
   - [ ] ê·¸ë£¹ ìš”ì•½ ì„œë¹„ìŠ¤ ë¡œì§ (`group_service.py` ì‹ ê·œ)
   - [ ] ê·¸ë£¹ ìš”ì•½ ë¼ìš°í„° (`group.py` ì‹ ê·œ)

2. **Phase 2: LLM í†µí•©** (í•„ìˆ˜)

   - [ ] LLM ê¸°ë°˜ ìì—°ì–´ ìš”ì•½ ê¸°ëŠ¥
   - [ ] Ollama ì—°ë™ ê°•í™”

3. **Phase 3: ì—ëŸ¬ ì²˜ë¦¬** (í•„ìˆ˜)

   - [ ] Warnings ì‹œìŠ¤í…œ êµ¬í˜„
   - [ ] ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬

4. **Phase 4: í…ŒìŠ¤íŠ¸ & ê²€ì¦** (ê¶Œì¥)
   - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
   - [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰

---

## 4. íŒŒì¼ ìˆ˜ì • ìƒì„¸

### 4.1 ì‹ ê·œ íŒŒì¼

#### ğŸ“„ `app/models.py` (ìˆ˜ì •)

**ì¶”ê°€í•  ëª¨ë¸:**

```python
# ê·¸ë£¹ ìš”ì•½ ìš”ì²­
class GroupSummaryRequest(BaseModel):
    plan_ids: list[int] = Field(..., min_length=1)

# ê·¸ë£¹ ìš”ì•½ ë°ì´í„°
class GroupSummaryData(BaseModel):
    total_plans_analyzed: int
    total_records: int
    total_distance_km: float
    avg_distance_per_plan_km: float
    total_travel_minutes: int
    avg_travel_minutes_per_plan: float
    total_late_minutes: int
    avg_late_minutes_per_plan: float
    total_wait_minutes: int
    avg_wait_minutes_per_plan: float

# ê·¸ë£¹ ìš”ì•½ ì‘ë‹µ
class GroupSummaryResponse(BaseModel):
    success: bool
    data: GroupSummaryData
    warnings: Optional[list[str]] = None

# ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ìš”ì²­
class GroupTextSummaryRequest(BaseModel):
    plan_ids: list[int] = Field(..., min_length=1)
    style: str = ""
    notes: str = ""
    mode: str = "llm"  # "rules" | "prompt" | "llm"
    seed: Optional[int] = None

# ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì‘ë‹µ
class GroupTextSummaryResponse(BaseModel):
    success: bool
    data: str
    warnings: Optional[list[str]] = None
```

**ë³µì¡ë„:** ë‚®ìŒ (ê¸°ì¡´ íŒ¨í„´ ì¬ì‚¬ìš©)

---

#### ğŸ“„ `app/services/group_service.py` (ì‹ ê·œ)

**ì—­í• :**

- ì—¬ëŸ¬ plan_idì˜ ë©”íŠ¸ë¦­ ë°ì´í„° ì§‘ê³„
- ê·¸ë£¹ í†µê³„ ê³„ì‚°
- LLM í”„ë¡¬í”„íŠ¸ ìƒì„± ë° í˜¸ì¶œ

**ì£¼ìš” í•¨ìˆ˜:**

```python
def compute_group_summary(plan_ids: list[int]) -> tuple[dict, list[str]]:
    """
    ì—¬ëŸ¬ í”Œëœì˜ ë©”íŠ¸ë¦­ì„ ì§‘ê³„í•˜ì—¬ ê·¸ë£¹ ìš”ì•½ ìƒì„±

    Returns:
        (summary_dict, warnings_list)
    """
    pass

def group_summary_to_text(
    summary: dict,
    style: str = "",
    notes: str = "",
    mode: str = "llm"
) -> str:
    """
    ê·¸ë£¹ ìš”ì•½ ë°ì´í„°ë¥¼ ìì—°ì–´ë¡œ ë³€í™˜
    """
    pass
```

**ë³µì¡ë„:** ì¤‘ê°„ (ê¸°ì¡´ `report_service.py`ì˜ `compute_summary` ë¡œì§ ì¬ì‚¬ìš© ê°€ëŠ¥)

---

#### ğŸ“„ `app/routers/group.py` (ì‹ ê·œ)

**ì—­í• :**

- ê·¸ë£¹ ê´€ë ¨ API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
- ìš”ì²­ ê²€ì¦ ë° ì‘ë‹µ í¬ë§·íŒ…

**ì—”ë“œí¬ì¸íŠ¸:**

```python
@router.post("/group/summary")
async def get_group_summary(req: GroupSummaryRequest) -> GroupSummaryResponse:
    """POST /metrics/group/summary"""
    pass

@router.post("/group/summary/text")
async def get_group_summary_text(req: GroupTextSummaryRequest) -> GroupTextSummaryResponse:
    """POST /metrics/group/summary/text"""
    pass
```

**ë³µì¡ë„:** ë‚®ìŒ (ê¸°ì¡´ `report.py` íŒ¨í„´ ì¬ì‚¬ìš©)

---

### 4.2 ìˆ˜ì • íŒŒì¼

#### ğŸ“„ `app/main.py` (ìˆ˜ì •)

**ë³€ê²½ ë‚´ìš©:**

- ì‹ ê·œ ê·¸ë£¹ ë¼ìš°í„° ë“±ë¡

```python
from app.routers.group import router as group_router

def create_app() -> FastAPI:
    app = FastAPI(title="Oathkeeper Metrics Analyzer (Modular)")
    app.include_router(metrics_router, prefix="/metrics", tags=["metrics"])
    app.include_router(report_router,  prefix="/metrics", tags=["report"])
    app.include_router(llm_router,     prefix="/metrics", tags=["llm"])
    app.include_router(group_router,   prefix="/metrics", tags=["group"])  # ì‹ ê·œ
    return app
```

**ë³µì¡ë„:** ë§¤ìš° ë‚®ìŒ (1ì¤„ ì¶”ê°€)

---

#### ğŸ“„ `app/storage.py` (ìˆ˜ì • ê°€ëŠ¥ì„±)

**í˜„ì¬ ìƒíƒœ:**

- `iter_metrics(plan_id)`: ë‹¨ì¼ í”Œëœì˜ ë©”íŠ¸ë¦­ ë°˜ë³µì ì œê³µ

**í•„ìš” ì—¬ë¶€:**

- ê¸°ì¡´ í•¨ìˆ˜ë¡œ ì¶©ë¶„ (ì—¬ëŸ¬ plan_idë¥¼ ìˆœíšŒí•˜ë©° í˜¸ì¶œ ê°€ëŠ¥)
- **ìˆ˜ì • ë¶ˆí•„ìš”**

---

#### ğŸ“„ `app/services/report_service.py` (ì°¸ì¡°ë§Œ)

**í™œìš© ë°©ë²•:**

- `compute_summary()` ë¡œì§ì„ ì°¸ê³ í•˜ì—¬ `compute_group_summary()` êµ¬í˜„
- `_llm_text_with_ollama()` í•¨ìˆ˜ ì¬ì‚¬ìš© ë˜ëŠ” ì°¸ì¡°

**ë³µì¡ë„:** ì—†ìŒ (ìˆ˜ì • ë¶ˆí•„ìš”, ì°¸ì¡°ë§Œ)

---

### 4.3 ìµœì¢… ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡° (ì‹ ê·œ API ì¶”ê°€ í›„)

| Method   | Endpoint                          | ì„¤ëª…                      | íŒŒì¼           |
| -------- | --------------------------------- | ------------------------- | -------------- |
| POST     | `/metrics/analyze`                | ë‹¨ì¼ ë©”íŠ¸ë¦­ ìˆ˜ì§‘          | `metrics.py`   |
| GET      | `/metrics/report/{plan_id}`       | ë‹¨ì¼ í”Œëœ ë¦¬í¬íŠ¸          | `report.py`    |
| GET      | `/metrics/report/{plan_id}/text`  | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ (ê¸°ë³¸)   | `report.py`    |
| POST     | `/metrics/report/{plan_id}/text`  | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ (ì»¤ìŠ¤í…€) | `report.py`    |
| POST     | `/metrics/llm/generate`           | LLM ë²”ìš© ìƒì„±             | `llm.py`       |
| **POST** | **`/metrics/group/summary`**      | **ê·¸ë£¹ í†µê³„ ìš”ì•½** âœ¨     | **`group.py`** |
| **POST** | **`/metrics/group/summary/text`** | **ê·¸ë£¹ ìì—°ì–´ ìš”ì•½** âœ¨   | **`group.py`** |

> âœ¨ = ì‹ ê·œ ì¶”ê°€

---

## 5. í…ŒìŠ¤íŠ¸ ê³„íš

### 5.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

#### `test_group_service.py`

```python
def test_compute_group_summary_success():
    """ì •ìƒì ì¸ ê·¸ë£¹ ìš”ì•½ ê³„ì‚°"""
    pass

def test_compute_group_summary_partial_failure():
    """ì¼ë¶€ plan_id ëˆ„ë½ ì‹œ warnings ë°˜í™˜"""
    pass

def test_compute_group_summary_all_failure():
    """ëª¨ë“  plan_id ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ë°œìƒ"""
    pass

def test_group_summary_to_text():
    """LLM í…ìŠ¤íŠ¸ ìƒì„±"""
    pass
```

### 5.2 í†µí•© í…ŒìŠ¤íŠ¸ (ìˆ˜ë™)

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1: ì •ìƒ ê·¸ë£¹ ìš”ì•½

```bash
POST http://localhost:8001/metrics/group/summary
Content-Type: application/json

{
  "plan_ids": [1, 2]
}
```

**ì˜ˆìƒ ì‘ë‹µ:**

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 2,
    "total_records": 50,
    "total_distance_km": 120.5,
    "avg_distance_per_plan_km": 60.25,
    ...
  }
}
```

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 2: ì¼ë¶€ plan_id ëˆ„ë½

```bash
POST http://localhost:8001/metrics/group/summary
Content-Type: application/json

{
  "plan_ids": [1, 999]
}
```

**ì˜ˆìƒ ì‘ë‹µ:**

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 1,
    ...
  },
  "warnings": [
    "plan_id '999' was not found."
  ]
}
```

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 3: ëª¨ë“  plan_id ì‹¤íŒ¨

```bash
POST http://localhost:8001/metrics/group/summary
Content-Type: application/json

{
  "plan_ids": [888, 999]
}
```

**ì˜ˆìƒ ì‘ë‹µ:**

```json
{
  "success": false,
  "data": null,
  "message": "No data available for the given plan_ids."
}
```

**HTTP ìƒíƒœ:** 409 Conflict

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 4: ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½

```bash
POST http://localhost:8001/metrics/group/summary/text
Content-Type: application/json

{
  "plan_ids": [1, 2],
  "style": "ì¹œê·¼í•œ í†¤ìœ¼ë¡œ",
  "notes": "ê¸ì •ì ì¸ ë©´ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”."
}
```

**ì˜ˆìƒ ì‘ë‹µ:**

```json
{
  "success": true,
  "data": "ì—¬ëŸ¬ë¶„ì˜ ê·¸ë£¹ì€ ì´ 2ê°œì˜ ì•½ì†ì„ í†µí•´ í‰ê·  60kmë¥¼ ì´ë™í–ˆì–´ìš”! ì‹œê°„ ê´€ë¦¬ë„ ì˜ í•˜ê³  ê³„ì‹œë„¤ìš”. ğŸ‘"
}
```

### 5.3 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

- **ëŒ€ëŸ‰ plan_ids ì²˜ë¦¬**: 100ê°œ ì´ìƒì˜ plan_id ìš”ì²­ ì‹œ ì‘ë‹µ ì‹œê°„ ì¸¡ì •
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ëŒ€ìš©ëŸ‰ JSONL íŒŒì¼ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í™•ì¸

---

## 6. ìœ„í—˜ ìš”ì†Œ ë° ê³ ë ¤ì‚¬í•­

### 6.1 ë¼ìš°íŒ… ì¶©ëŒ ìœ„í—˜ âš ï¸

**ë¬¸ì œ:**

- ìµœê·¼ `/metrics/report` ê²½ë¡œì—ì„œ ì¶©ëŒ ì´ë ¥ ì¡´ì¬
- ì‹ ê·œ `/metrics/group/*` ê²½ë¡œê°€ ê¸°ì¡´ ê²½ë¡œì™€ ì¶©ëŒ ê°€ëŠ¥ì„±

**í•´ê²°ì±…:**

- âœ… ì‹ ê·œ ë¼ìš°í„°ë¥¼ ë³„ë„ íŒŒì¼ (`group.py`)ë¡œ ë¶„ë¦¬
- âœ… ëª…í™•í•œ prefix ì‚¬ìš© (`/group/summary`)
- âœ… ê¸°ì¡´ ë¼ìš°í„°ì™€ ë…ë¦½ì ìœ¼ë¡œ ë“±ë¡

### 6.2 ë°ì´í„° ì¼ê´€ì„± âš ï¸

**ë¬¸ì œ:**

- JSONL íŒŒì¼ì´ ì†ìƒë˜ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš°
- ì¼ë¶€ plan_idì˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°

**í•´ê²°ì±…:**

- âœ… `storage.py`ì˜ `iter_metrics()`ê°€ ì´ë¯¸ ì˜ˆì™¸ ì²˜ë¦¬ êµ¬í˜„
- âœ… Warnings ì‹œìŠ¤í…œìœ¼ë¡œ ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš©
- âœ… ë¹ˆ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ì¶”ê°€

### 6.3 LLM í†µí•© ë¶ˆí™•ì‹¤ì„± âš ï¸

**ë¬¸ì œ:**

- í˜„ì¬ `llm_adapter.py`ê°€ ìŠ¤ì¼ˆë ˆí†¤ ìƒíƒœ
- Ollama ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥ì„±

**í•´ê²°ì±…:**

- âœ… `report_service.py`ì˜ `_llm_text_with_ollama()` ì¬ì‚¬ìš©
- âœ… LLM ì‹¤íŒ¨ ì‹œ fallbackìœ¼ë¡œ rules ëª¨ë“œ ì‚¬ìš©
- âœ… í™˜ê²½ ë³€ìˆ˜ë¡œ LLM ë°±ì—”ë“œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ êµ¬í˜„

### 6.4 ì„±ëŠ¥ ë¬¸ì œ âš ï¸

**ë¬¸ì œ:**

- ìˆ˜ì‹­ ê°œì˜ plan_id ì²˜ë¦¬ ì‹œ I/O ë³‘ëª© ê°€ëŠ¥ì„±
- ëŒ€ìš©ëŸ‰ JSONL íŒŒì¼ ë©”ëª¨ë¦¬ ë¡œë“œ

**í•´ê²°ì±…:**

- âœ… Generator íŒ¨í„´ ì‚¬ìš© (`iter_metrics()`)
- âš ï¸ í•„ìš”ì‹œ ë¹„ë™ê¸° I/O ê³ ë ¤ (í–¥í›„ ê°œì„ )
- âš ï¸ ìºì‹± ì „ëµ ê³ ë ¤ (í–¥í›„ ê°œì„ )

### 6.5 ì—ëŸ¬ ì‘ë‹µ ì¼ê´€ì„± ğŸ”

**ë¬¸ì œ:**

- ê¸°ì¡´ APIëŠ” 409 Conflictë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹ ê·œ APIëŠ” 200 OK + warnings ì‚¬ìš©
- Spring ì„œë²„ì™€ì˜ ì—ëŸ¬ ì²˜ë¦¬ ê·œì•½ í™•ì¸ í•„ìš”

**í•´ê²°ì±…:**

- âœ… ìš”êµ¬ì‚¬í•­ ëª…ì„¸ëŒ€ë¡œ êµ¬í˜„ (200 OK + warnings)
- ğŸ” **Spring íŒ€ê³¼ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ì¬í™•ì¸ í•„ìš”**

---

## 7. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ëª¨ë¸ ë° ì„œë¹„ìŠ¤ ë¡œì§

- [ ] `models.py`ì— ê·¸ë£¹ ìš”ì•½ ê´€ë ¨ Pydantic ëª¨ë¸ ì¶”ê°€
- [ ] `app/services/group_service.py` íŒŒì¼ ìƒì„±
- [ ] `compute_group_summary()` í•¨ìˆ˜ êµ¬í˜„
  - [ ] ì—¬ëŸ¬ plan_id ìˆœíšŒ
  - [ ] ë©”íŠ¸ë¦­ ë°ì´í„° ì§‘ê³„
  - [ ] í†µê³„ ê³„ì‚°
  - [ ] Warnings ìƒì„±
- [ ] `group_summary_to_text()` í•¨ìˆ˜ êµ¬í˜„
  - [ ] LLM í”„ë¡¬í”„íŠ¸ ìƒì„±
  - [ ] Ollama í˜¸ì¶œ
  - [ ] ì‘ë‹µ ì •ì œ

### Phase 2: ë¼ìš°í„° ë° í†µí•©

- [ ] `app/routers/group.py` íŒŒì¼ ìƒì„±
- [ ] `POST /group/summary` ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] `POST /group/summary/text` ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] `main.py`ì— ê·¸ë£¹ ë¼ìš°í„° ë“±ë¡
- [ ] ì—ëŸ¬ ì²˜ë¦¬ êµ¬í˜„
  - [ ] ë¶€ë¶„ ì„±ê³µ (200 + warnings)
  - [ ] ì™„ì „ ì‹¤íŒ¨ (409 Conflict)

### Phase 3: í…ŒìŠ¤íŠ¸

- [ ] ì •ìƒ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] ì¼ë¶€ plan_id ëˆ„ë½ í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë“  plan_id ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
- [ ] LLM í…ìŠ¤íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ëŒ€ëŸ‰ plan_ids)

### Phase 4: ë¬¸ì„œí™”

- [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸ (Swagger/OpenAPI)
- [ ] README ì—…ë°ì´íŠ¸
- [ ] ì‘ì—… ì™„ë£Œ ë³´ê³ ì„œ ì‘ì„±

---

## 8. ì˜ˆìƒ ì‘ì—… ì‹œê°„

| ë‹¨ê³„             | ì˜ˆìƒ ì‹œê°„   | ë¹„ê³                  |
| ---------------- | ----------- | -------------------- |
| ëª¨ë¸ ì •ì˜        | 30ë¶„        | ê¸°ì¡´ íŒ¨í„´ ì¬ì‚¬ìš©     |
| ì„œë¹„ìŠ¤ ë¡œì§ êµ¬í˜„ | 2-3ì‹œê°„     | ì§‘ê³„ ë¡œì§ + LLM í†µí•© |
| ë¼ìš°í„° êµ¬í˜„      | 1ì‹œê°„       | ê¸°ì¡´ íŒ¨í„´ ì¬ì‚¬ìš©     |
| í…ŒìŠ¤íŠ¸           | 1-2ì‹œê°„     | ìˆ˜ë™ + ìë™ í…ŒìŠ¤íŠ¸   |
| ë¬¸ì„œí™”           | 30ë¶„        |                      |
| **ì´ ì˜ˆìƒ ì‹œê°„** | **5-7ì‹œê°„** | ìˆœìˆ˜ ê°œë°œ ì‹œê°„       |

---

## 9. ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì‘ì—…

1. âœ… ì´ ê³„íšì„œ ê²€í†  ë° ìŠ¹ì¸ ìš”ì²­
2. â­ï¸ Spring íŒ€ê³¼ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ì¬í™•ì¸
3. â­ï¸ Phase 1 êµ¬í˜„ ì‹œì‘

### ìŠ¹ì¸ í›„ ì‘ì—… ìˆœì„œ

1. `models.py` ìˆ˜ì •
2. `group_service.py` êµ¬í˜„
3. `group.py` ë¼ìš°í„° êµ¬í˜„
4. `main.py` í†µí•©
5. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
6. ë¬¸ì„œí™”

---

## 10. ì§ˆë¬¸ ì‚¬í•­

> ğŸ” **Spring ê°œë°œíŒ€ì— í™•ì¸ í•„ìš”:**

1. **ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ í™•ì¸**

   - ë¶€ë¶„ ì„±ê³µ ì‹œ `200 OK + warnings` í˜•ì‹ì´ Spring ì„œë²„ì—ì„œ ì²˜ë¦¬ ê°€ëŠ¥í•œê°€ìš”?
   - ê¸°ì¡´ APIë“¤ê³¼ì˜ ì¼ê´€ì„±ì€ ê´œì°®ì€ê°€ìš”?

2. **plan_ids ê°œìˆ˜ ì œí•œ**

   - í•œ ë²ˆì— ìš”ì²­ ê°€ëŠ¥í•œ ìµœëŒ€ plan_id ê°œìˆ˜ ì œí•œì´ í•„ìš”í•œê°€ìš”?
   - ì˜ˆ: ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ í—ˆìš©

3. **LLM ëª¨ë“œ ì„ íƒ**

   - ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ì—ì„œ ê¸°ë³¸ ëª¨ë“œë¥¼ "llm"ìœ¼ë¡œ í• ê¹Œìš”, "rules"ë¡œ í• ê¹Œìš”?
   - Ollama ì„œë²„ê°€ í•­ìƒ ì‹¤í–‰ ì¤‘ì¸ê°€ìš”?

4. **ì¶”ê°€ í†µê³„ í•„ë“œ**
   - ìš”êµ¬ì‚¬í•­ ëª…ì„¸ì— ì—†ëŠ” ì¶”ê°€ í†µê³„ê°€ í•„ìš”í•œê°€ìš”?
   - ì˜ˆ: ìµœëŒ€/ìµœì†Œ ì´ë™ ê±°ë¦¬, ì¤‘ì•™ê°’ ë“±

---

## 11. ì°¸ê³  ìë£Œ

- [PYTHON_API_REQ.md](file:///c:/workspace/oathkeeper_python/docs/PYTHON_API_REQ.md) - ì‹ ê·œ API ìš”ì²­ ëª…ì„¸
- [ë¼ìš°íŒ…*ìˆ˜ì •*ì‘ì—…\_ë‚´ì—­.md](file:///c:/workspace/oathkeeper_python/ë¼ìš°íŒ…_ìˆ˜ì •_ì‘ì—…_ë‚´ì—­.md) - ìµœê·¼ ë¦¬íŒ©í† ë§ ì´ë ¥
- [app/services/report_service.py](file:///c:/workspace/oathkeeper_python/app/services/report_service.py) - ì°¸ê³ í•  ê¸°ì¡´ ë¡œì§
- [app/routers/report.py](file:///c:/workspace/oathkeeper_python/app/routers/report.py) - ì°¸ê³ í•  ë¼ìš°í„° íŒ¨í„´

---

## ë¶€ë¡: ì½”ë“œ ìŠ¤ë‹ˆí« ì˜ˆì‹œ

### A. `compute_group_summary()` ì˜ì‚¬ ì½”ë“œ

```python
def compute_group_summary(plan_ids: list[int]) -> tuple[dict, list[str]]:
    warnings = []
    all_records = []
    valid_plan_ids = []

    for plan_id in plan_ids:
        if not has_plan_dir(plan_id):
            warnings.append(f"plan_id '{plan_id}' was not found.")
            continue

        records = list(iter_metrics(plan_id))
        if not records:
            warnings.append(f"plan_id '{plan_id}' has no metrics data.")
            continue

        all_records.extend(records)
        valid_plan_ids.append(plan_id)

    if not all_records:
        raise HTTPException(
            status_code=409,
            detail={"code": "NO_DATA", "message": "No data available for the given plan_ids."}
        )

    # ì§‘ê³„ ë¡œì§
    total_records = len(all_records)
    total_distance = sum(r.get("distance_km", 0) for r in all_records)
    total_late = sum(r.get("late_minutes", 0) or 0 for r in all_records)
    # ... ê¸°íƒ€ í†µê³„ ê³„ì‚°

    summary = {
        "total_plans_analyzed": len(valid_plan_ids),
        "total_records": total_records,
        "total_distance_km": total_distance,
        "avg_distance_per_plan_km": total_distance / len(valid_plan_ids),
        # ...
    }

    return summary, warnings
```

### B. LLM í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ

```python
def _build_group_prompt(summary: dict, style: str, notes: str) -> str:
    base = f"""
ë‹¤ìŒì€ {summary['total_plans_analyzed']}ê°œì˜ ì•½ì†ì— ëŒ€í•œ ê·¸ë£¹ í†µê³„ì…ë‹ˆë‹¤:

- ì´ ê¸°ë¡ ìˆ˜: {summary['total_records']}ê°œ
- ì´ ì´ë™ ê±°ë¦¬: {summary['total_distance_km']:.1f}km
- ì•½ì†ë‹¹ í‰ê·  ì´ë™ ê±°ë¦¬: {summary['avg_distance_per_plan_km']:.1f}km
- ì´ ì§€ê° ì‹œê°„: {summary['total_late_minutes']}ë¶„
- ì•½ì†ë‹¹ í‰ê·  ì§€ê° ì‹œê°„: {summary['avg_late_minutes_per_plan']:.1f}ë¶„

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ ê·¸ë£¹ì˜ ì „ë°˜ì ì¸ í™œë™ íŒ¨í„´ì„ ìš”ì•½í•´ì£¼ì„¸ìš”.
"""

    if style:
        base += f"\nìŠ¤íƒ€ì¼: {style}"
    if notes:
        base += f"\nì¶”ê°€ ìš”ì²­: {notes}"

    return base
```

---

**ì‘ì„± ì™„ë£Œì¼:** 2025-11-24  
**ê²€í†  ìš”ì²­:** Spring ì„œë²„ ê°œë°œíŒ€  
**ë‹¤ìŒ ë‹¨ê³„:** ìŠ¹ì¸ í›„ Phase 1 êµ¬í˜„ ì‹œì‘
