# Python AI μ„λ²„ API v2 μμ • μ‘μ—… κ³„νμ„

**μ‘μ„±μΌ:** 2025-11-25  
**μ‘μ„±μ:** AI Assistant  
**μ°Έμ΅° λ¬Έμ„:** [PYTHON_API_REQ.md (v2)](file:///c:/workspace/oathkeeper_python/docs/PYTHON_API_REQ.md)

---

## π“‹ λ³€κ²½ μ”μ²­ μ”μ•½

### v1 β†’ v2 μ£Όμ” λ³€κ²½μ‚¬ν•­

| ν•­λ©             | v1 (κΈ°μ΅΄)                                     | v2 (λ³€κ²½)                                       |
| ---------------- | --------------------------------------------- | ----------------------------------------------- |
| **API κ°μ**     | 2κ° (λ¶„λ¦¬)                                    | 1κ° (ν†µν•©)                                      |
| **μ—”λ“ν¬μΈνΈ 1** | `POST /metrics/group/summary` (ν†µκ³„λ§)        | `POST /metrics/group/summary` (ν†µκ³„ + ν…μ¤νΈ)   |
| **μ—”λ“ν¬μΈνΈ 2** | `POST /metrics/group/summary/text` (ν…μ¤νΈλ§) | β **μ‚­μ λ¨**                                   |
| **μ”μ²­ ν•„λ“**    | `plan_ids`                                    | `plan_ids`, `style`, `notes`                    |
| **μ‘λ‹µ κµ¬μ΅°**    | `{ group_summary: {...} }`                    | `{ group_summary: {...}, text_summary: "..." }` |

### λ³€κ²½ μ΄μ 

- Spring μ„λ²„μ—μ„ λΉ„λ™κΈ° νΈμ¶ ν›„ DB μ €μ¥ μ‹ **ν• λ²μ μ”μ²­**μΌλ΅ λ¨λ“  λ°μ΄ν„°λ¥Ό λ°›λ” κ²ƒμ΄ ν¨μ¨μ 
- 2λ²μ API νΈμ¶ λ€μ‹  1λ²μ νΈμ¶λ΅ ν†µν•©ν•μ—¬ μ„±λ¥ ν–¥μƒ

---

## π― μ‘μ—… λ©ν‘

1. β… **κΈ°μ΅΄ μ½”λ“ κ²€ν† ** - μ–΄μ  κµ¬ν„ν• v1 μ½”λ“ ν™•μΈ
2. π”§ **API ν†µν•©** - 2κ° μ—”λ“ν¬μΈνΈλ¥Ό 1κ°λ΅ ν†µν•©
3. π“¦ **λ¨λΈ μμ •** - μ”μ²­/μ‘λ‹µ λ¨λΈ λ³€κ²½
4. π§ **ν…μ¤νΈ** - μμ •λ API λ™μ‘ ν™•μΈ

---

## π“ μμ • λ€μƒ νμΌ

### 1. `app/models.py`

**λ³€κ²½ μ „ (v1):**

```python
class GroupSummaryRequest(BaseModel):
    plan_ids: list[int]

class GroupSummaryData(BaseModel):
    total_plans_analyzed: int
    total_records: int
    # ... ν†µκ³„ ν•„λ“λ“¤

class GroupSummaryResponse(BaseModel):
    success: bool
    data: GroupSummaryData
    warnings: Optional[list[str]]

class GroupTextSummaryRequest(BaseModel):  # β† μ‚­μ  μμ •
    plan_ids: list[int]
    style: str
    notes: str
    mode: str
```

**λ³€κ²½ ν›„ (v2):**

```python
class GroupSummaryRequest(BaseModel):
    plan_ids: list[int]
    style: str = ""  # β† μ¶”κ°€
    notes: str = ""  # β† μ¶”κ°€
    mode: str = "llm"  # β† μ¨κ²¨μ§„ μµμ… (κΈ°λ³Έκ°’)

class GroupSummaryData(BaseModel):
    group_summary: GroupSummaryStats  # β† λ‚΄λ¶€ ν΄λμ¤ λ¶„λ¦¬
    text_summary: str  # β† μ¶”κ°€

class GroupSummaryStats(BaseModel):  # β† μ‹ κ·
    total_plans_analyzed: int
    total_records: int
    # ... ν†µκ³„ ν•„λ“λ“¤

class GroupSummaryResponse(BaseModel):
    success: bool
    data: GroupSummaryData  # β† κµ¬μ΅° λ³€κ²½
    warnings: Optional[list[str]]

# GroupTextSummaryRequest, GroupTextSummaryResponse μ‚­μ 
```

---

### 2. `app/routers/group.py`

**λ³€κ²½ μ „ (v1):**

```python
@router.post("/group/summary")
async def get_group_summary(req: GroupSummaryRequest):
    # ν†µκ³„λ§ λ°ν™
    summary, warnings = compute_group_summary(req.plan_ids)
    return {"success": True, "data": summary, "warnings": warnings}

@router.post("/group/summary/text")  # β† μ‚­μ  μμ •
async def get_group_summary_text(req: GroupTextSummaryRequest):
    # ν…μ¤νΈλ§ λ°ν™
    ...
```

**λ³€κ²½ ν›„ (v2):**

```python
@router.post("/group/summary")
async def get_group_summary(req: GroupSummaryRequest):
    # ν†µκ³„ + ν…μ¤νΈ ν•¨κ» λ°ν™
    summary, warnings = compute_group_summary(
        req.plan_ids,
        style=req.style,
        notes=req.notes,
        mode=req.mode
    )
    return {"success": True, "data": summary, "warnings": warnings}

# /group/summary/text μ—”λ“ν¬μΈνΈ μ‚­μ 
```

---

### 3. `app/services/group_service.py`

**λ³€κ²½ μ „ (v1):**

```python
def compute_group_summary(plan_ids: List[int]) -> Tuple[Dict, List[str]]:
    # ν†µκ³„λ§ κ³„μ‚°
    return {
        "total_plans_analyzed": ...,
        "total_records": ...,
        # ... ν†µκ³„ ν•„λ“λ“¤
    }, warnings

def group_summary_to_text(summary, style, notes, mode) -> str:
    # λ³„λ„ ν•¨μλ΅ ν…μ¤νΈ μƒμ„±
    ...
```

**λ³€κ²½ ν›„ (v2):**

```python
def compute_group_summary(
    plan_ids: List[int],
    style: str = "",
    notes: str = "",
    mode: str = "llm"
) -> Tuple[Dict, List[str]]:
    # ν†µκ³„ κ³„μ‚°
    stats = {
        "total_plans_analyzed": ...,
        "total_records": ...,
        # ... ν†µκ³„ ν•„λ“λ“¤
    }

    # ν…μ¤νΈ μƒμ„± (ν•¨κ» μν–‰)
    text = group_summary_to_text(stats, style, notes, mode)

    # ν†µν•© μ‘λ‹µ
    return {
        "group_summary": stats,
        "text_summary": text
    }, warnings

# group_summary_to_textλ” λ‚΄λ¶€ ν—¬νΌλ΅ μ μ§€
```

---

## π”„ μ‘μ—… λ‹¨κ³„

### Phase 1: λ¨λΈ μμ • β…

1. **`app/models.py` μμ •**
   - [ ] `GroupSummaryRequest`μ— `style`, `notes`, `mode` ν•„λ“ μ¶”κ°€
   - [ ] `GroupSummaryStats` λ‚΄λ¶€ ν΄λμ¤ μƒμ„± (κΈ°μ΅΄ ν†µκ³„ ν•„λ“)
   - [ ] `GroupSummaryData` κµ¬μ΅° λ³€κ²½ (`group_summary` + `text_summary`)
   - [ ] `GroupTextSummaryRequest`, `GroupTextSummaryResponse` ν΄λμ¤ μ‚­μ 

**μμƒ λ³€κ²½λ‰:** μ•½ 30μ¤„ μμ •

---

### Phase 2: μ„λΉ„μ¤ λ΅μ§ μμ • β…

2. **`app/services/group_service.py` μμ •**
   - [ ] `compute_group_summary()` ν•¨μ μ‹κ·Έλ‹μ² λ³€κ²½ (νλΌλ―Έν„° μ¶”κ°€)
   - [ ] ν†µκ³„ κ³„μ‚° ν›„ ν…μ¤νΈ μƒμ„±κΉμ§€ ν• λ²μ— μν–‰
   - [ ] μ‘λ‹µ κµ¬μ΅° λ³€κ²½ (`group_summary` + `text_summary`)

**μμƒ λ³€κ²½λ‰:** μ•½ 20μ¤„ μμ •

---

### Phase 3: λΌμ°ν„° μμ • β…

3. **`app/routers/group.py` μμ •**
   - [ ] `/group/summary` μ—”λ“ν¬μΈνΈ μμ • (νλΌλ―Έν„° μ „λ‹¬)
   - [ ] `/group/summary/text` μ—”λ“ν¬μΈνΈ μ‚­μ 
   - [ ] μ‘λ‹µ λ¨λΈ νƒ€μ… λ³€κ²½

**μμƒ λ³€κ²½λ‰:** μ•½ 40μ¤„ μ‚­μ , 10μ¤„ μμ •

---

### Phase 4: ν…μ¤νΈ λ° κ²€μ¦ β…

4. **ν…μ¤νΈ**
   - [ ] μ„λ²„ μ¬μ‹μ‘
   - [ ] Swagger UIμ—μ„ ν†µν•© API ν…μ¤νΈ
   - [ ] μ‘λ‹µ ν•μ‹ κ²€μ¦ (`group_summary` + `text_summary`)
   - [ ] warnings λ™μ‘ ν™•μΈ
   - [ ] 409 μ—λ¬ μΌ€μ΄μ¤ ν™•μΈ

---

## π“ μμƒ μ‘λ‹µ λΉ„κµ

### v1 μ‘λ‹µ (κΈ°μ΅΄)

#### API 1: `/metrics/group/summary`

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 4,
    "total_records": 128,
    "total_distance_km": 258.4,
    "avg_distance_per_plan_km": 64.6,
    ...
  }
}
```

#### API 2: `/metrics/group/summary/text`

```json
{
  "success": true,
  "data": "λ¶„μ„λ 4κ°μ μ•½μ†μ— λ”°λ¥΄λ©΄..."
}
```

### v2 μ‘λ‹µ (λ³€κ²½)

#### API (ν†µν•©): `/metrics/group/summary`

```json
{
  "success": true,
  "data": {
    "group_summary": {
      "total_plans_analyzed": 4,
      "total_records": 128,
      "total_distance_km": 258.4,
      "avg_distance_per_plan_km": 64.6,
      ...
    },
    "text_summary": "λ¶„μ„λ 4κ°μ μ•½μ†μ— λ”°λ¥΄λ©΄..."
  }
}
```

---

## β οΈ μ£Όμμ‚¬ν•­

### 1. ν•μ„ νΈν™μ„± λ¬Έμ 

**λ¬Έμ :**

- κΈ°μ΅΄ v1 APIλ¥Ό μ‚¬μ© μ¤‘μΈ ν΄λΌμ΄μ–ΈνΈκ°€ μμ„ μ μμ
- μ‘λ‹µ κµ¬μ΅°κ°€ λ³€κ²½λμ–΄ JSON νμ‹± μ¤λ¥ λ°μƒ κ°€λ¥

**ν•΄κ²°μ±…:**

- β… Spring ν€κ³Ό λ™μ‹ λ°°ν¬ κ³„ν μλ¦½
- β… λλ” v1 μ—”λ“ν¬μΈνΈ μ μ§€ (`/metrics/group/summary/v1`)

**μ„ νƒ:**

- Spring ν€μ΄ μ•„μ§ v1μ„ μ‚¬μ©ν•μ§€ μ•μ•μΌλ―€λ΅ **λ°”λ΅ v2λ΅ λ³€κ²½ κ°€λ¥**

---

### 2. LLM μ²λ¦¬ μ‹κ°„

**λ¬Έμ :**

- ν†µκ³„ + LLM ν…μ¤νΈ μƒμ„±μ„ ν• λ²μ— μν–‰ν•λ©΄ **μ‘λ‹µ μ‹κ°„ μ¦κ°€**
- LLM λ¨λ“: 5~30μ΄ μ†μ” κ°€λ¥

**ν•΄κ²°μ±…:**

- β… Springμ—μ„ λΉ„λ™κΈ° νΈμ¶ (μ΄λ―Έ κ³„νλ¨)
- β… Timeout μ„¤μ • μ¶©λ¶„ν κΈΈκ² (μµμ† 30μ΄)
- β… rules λ¨λ“ κΈ°λ³Έκ°’ κ³ λ ¤ (λΉ λ¥Έ μ‘λ‹µ)

**κ¶μ¥:**

- `mode` κΈ°λ³Έκ°’μ„ `"rules"`λ΅ μ„¤μ •ν•μ—¬ λΉ λ¥Έ μ‘λ‹µ μ κ³µ
- ν•„μ”μ‹μ—λ§ `"llm"` λ¨λ“ μ‚¬μ©

---

### 3. μ‘λ‹µ ν¬κΈ°

**λ³€κ²½ μ „:**

- API 1: ~500 bytes (ν†µκ³„λ§)
- API 2: ~200 bytes (ν…μ¤νΈλ§)

**λ³€κ²½ ν›„:**

- ν†µν•© API: ~700 bytes (ν†µκ³„ + ν…μ¤νΈ)

**μν–¥:** λ―Έλ―Έν•¨ (μ—¬μ „ν 1KB μ΄ν•)

---

## π§ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### μ‹λ‚λ¦¬μ¤ 1: μ •μƒ μ”μ²­

**μ”μ²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [1, 2],
  "style": "μΉκ·Όν• ν†¤μΌλ΅",
  "notes": "κΈμ •μ μΈ λ©΄μ„ κ°•μ΅°ν•΄μ£Όμ„Έμ”"
}
```

**μμƒ μ‘λ‹µ:**

```json
{
  "success": true,
  "data": {
    "group_summary": {
      "total_plans_analyzed": 2,
      "total_records": 50,
      ...
    },
    "text_summary": "μ—¬λ¬λ¶„μ κ·Έλ£Ήμ€ μ΄ 2κ°μ μ•½μ†μ„ ν†µν•΄..."
  },
  "warnings": null
}
```

---

### μ‹λ‚λ¦¬μ¤ 2: style, notes μƒλµ (κΈ°λ³Έκ°’)

**μ”μ²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [1, 2]
}
```

**μμƒ μ‘λ‹µ:**

- `style=""`, `notes=""`, `mode="llm"` κΈ°λ³Έκ°’ μ‚¬μ©
- μ •μƒ μ‘λ‹µ (ν†µκ³„ + κΈ°λ³Έ ν…μ¤νΈ)

---

### μ‹λ‚λ¦¬μ¤ 3: μΌλ¶€ plan_id λ„λ½

**μ”μ²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [1, 999]
}
```

**μμƒ μ‘λ‹µ:**

```json
{
  "success": true,
  "data": {
    "group_summary": { ... },
    "text_summary": "..."
  },
  "warnings": [
    "plan_id '999' was not found."
  ]
}
```

---

## π“ μ‘μ—… ν›„ λ¬Έμ„ μ—…λ°μ΄νΈ

### 1. `1124_νμ΄μ¬APIμ‘μ—…κΈ°λ΅.md` μ—…λ°μ΄νΈ

- v2 λ³€κ²½μ‚¬ν•­ μ¶”κ°€
- λ³€κ²½ μ΄λ ¥ κΈ°λ΅

### 2. Java κ°€μ΄λ“ μ—…λ°μ΄νΈ

- DTO ν΄λμ¤ λ³€κ²½
- μ”μ²­/μ‘λ‹µ μμ  μ—…λ°μ΄νΈ

---

## β… μ‘μ—… μ™„λ£ μ²΄ν¬λ¦¬μ¤νΈ

### Phase 1: λ¨λΈ μμ •

- [ ] `GroupSummaryRequest` μμ • (style, notes, mode μ¶”κ°€)
- [ ] `GroupSummaryStats` ν΄λμ¤ μƒμ„±
- [ ] `GroupSummaryData` κµ¬μ΅° λ³€κ²½
- [ ] λ¶ν•„μ”ν• ν΄λμ¤ μ‚­μ  (GroupTextSummary\*)

### Phase 2: μ„λΉ„μ¤ λ΅μ§ μμ •

- [ ] `compute_group_summary()` μ‹κ·Έλ‹μ² λ³€κ²½
- [ ] ν†µκ³„ + ν…μ¤νΈ ν†µν•© μƒμ„±
- [ ] μ‘λ‹µ κµ¬μ΅° λ³€κ²½

### Phase 3: λΌμ°ν„° μμ •

- [ ] `/group/summary` μ—”λ“ν¬μΈνΈ μμ •
- [ ] `/group/summary/text` μ—”λ“ν¬μΈνΈ μ‚­μ 

### Phase 4: ν…μ¤νΈ

- [ ] μ„λ²„ μ¬μ‹μ‘
- [ ] μ •μƒ μ”μ²­ ν…μ¤νΈ
- [ ] warnings ν…μ¤νΈ
- [ ] 409 μ—λ¬ ν…μ¤νΈ

### Phase 5: λ¬Έμ„ν™”

- [ ] μ‘μ—… κΈ°λ΅ μ—…λ°μ΄νΈ
- [ ] Java κ°€μ΄λ“ μ—…λ°μ΄νΈ

---

**μ‘μ—… μμƒ μ‹κ°„:** 30~40λ¶„  
**λ³µμ΅λ„:** μ¤‘κ°„ (κΈ°μ΅΄ μ½”λ“ μμ •)  
**μ„ν—λ„:** λ‚®μ (κΈ°μ΅΄ λ΅μ§ μ¬μ‚¬μ©)

---

**μ‘μ„± μ™„λ£μΌ:** 2025-11-25  
**κ²€ν†  μƒνƒ:** μ¤€λΉ„ μ™„λ£  
**λ‹¤μ λ‹¨κ³„:** Phase 1 μ‘μ—… μ‹μ‘

- [ ] **Phase 6: λ¬Έμ„ λ¦¬λ·° λ° λ°°ν¬**
  - μ‘μ—… κΈ°λ΅ λ° Java κ°€μ΄λ“ μµμΆ… κ²€ν† 
  - Spring ν€μ— μµμΆ… API μ¤ν™ μ „λ‹¬
  - λ°°ν¬ μ „ νκ·€ ν…μ¤νΈ μν–‰
