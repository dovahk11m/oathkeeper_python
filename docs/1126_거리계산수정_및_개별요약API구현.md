# 거리 계산 로직 수정 및 개별 플랜 요약 API 구현

**작성일:** 2025-11-26
**작성자:** Python AI 서버 개발팀

---

## 1. 배경 및 목적

### 1.1 거리 계산 오류 수정

- **증상:** 약속 리포트에서 이동 거리가 비현실적으로 크게 측정됨 (예: 236km).
- **원인:** 클라이언트가 보내는 `distance_km`가 **누적값**임에도 불구하고, 서버에서 이를 단순 **합산(sum)**하여 계산했기 때문.
- **해결:** 각 멤버별로 **최대값(max)**을 취하여 최종 이동 거리로 사용하도록 로직 수정.

### 1.2 개별 플랜 요약 API 추가

- **요구사항:** Java 서버의 후처리 로직에서 단일 Plan에 대한 요약 텍스트가 필요함.
- **해결:** `POST /metrics/plan/{plan_id}/summary` 엔드포인트 추가.

---

## 2. 주요 변경 사항

### 2.1 [Service] 거리/시간 집계 로직 변경

- **파일:** `app/services/report_service.py`
- **변경 내용:**
  - 기존: `sum(distance_km)` (모든 레코드 합산)
  - 변경: `sum(max(distance_km) per member)` (멤버별 최대값의 합)
  - 평균 계산: `total / total_records` → `total / member_count`

```python
# 변경 전
m["distance_km"] += d
...
avg_dist = total_dist / total_records

# 변경 후
m["distance_km"] = max(m["distance_km"], d)
...
avg_dist = total_dist / len(members)
```

### 2.2 [Router] 개별 플랜 요약 API 구현

- **파일:** `app/routers/report.py`
- **변경 내용:** 신규 엔드포인트 추가

```python
@router.post("/plan/{plan_id}/summary")
async def create_plan_summary(plan_id: int):
    summary = compute_summary(plan_id)
    _assert_ready_or_409(plan_id, summary)
    txt = summary_to_text(summary, mode="rules")
    return {"success": True, "data": {"plan_id": plan_id, "text_summary": txt}}
```

### 2.3 [Docs] API 스펙 문서 업데이트

- **파일:** `docs/1125_ 파이썬API스펙문서.md`
- **변경 내용:** 신규 API 명세 추가 및 구현 상태 업데이트.

---

## 3. 검증 결과

- **거리 계산:** 누적 데이터(1km, 2km, 3km) 입력 시 6km가 아닌 **3km**로 정상 계산됨을 확인.
- **API 호출:** `/metrics/plan/{plan_id}/summary` 호출 시 정상적으로 요약 텍스트 반환 확인.

---

## 4. 향후 계획

- Java 서버 연동 테스트 지원
- 추가적인 예외 케이스 모니터링
