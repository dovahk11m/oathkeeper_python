# λΌμ°ν… μμ • μ‘μ—… λ‚΄μ—­

## π“‹ λ¬Έμ  μƒν™©

`/metrics/report/{planId}` μ—”λ“ν¬μΈνΈκ°€ μ¬λ°”λ¥΄κ² λ™μ‘ν•μ§€ μ•λ” λ¬Έμ κ°€ λ°μƒν–μµλ‹λ‹¤.

### μ›μΈ λ¶„μ„

1. **λΌμ°ν„° μ¤‘λ³µ μ •μ**
   - `app/routers/metrics.py`μ— `/report/{plan_id}/text` μ—”λ“ν¬μΈνΈκ°€ μ •μλ¨
   - `app/routers/report.py`μ—λ„ `/report/{plan_id}` λ° `/report/{plan_id}/text` μ—”λ“ν¬μΈνΈκ°€ μ •μλ¨
   - λ‘ λΌμ°ν„° λ¨λ‘ `main.py`μ—μ„ `/metrics` prefixλ΅ λ“±λ΅λμ–΄ κ²½λ΅ μ¶©λ λ°μƒ

2. **ν•¨μ μ¤‘λ³µ μ •μ**
   - `app/routers/report.py` νμΌ λ‚΄μ— `compute_summary` ν•¨μκ°€ μ¤‘λ³µ μ •μλ¨
   - μ΄λ―Έ `app/services/report_service.py`μ—μ„ importν•κ³  μμ—μΌλ‚, νμΌ ν•λ‹¨μ— λ‹¤μ‹ μ •μλμ–΄ μμ—μ

3. **λΌμ°ν… κµ¬μ΅° λ¬Έμ **
   ```
   main.py:
   - app.include_router(metrics_router, prefix="/metrics")
   - app.include_router(report_router, prefix="/metrics")
   
   κ²°κ³Ό:
   - /metrics/report/{plan_id}/text (metrics.py) β μ¶©λ
   - /metrics/report/{plan_id} (report.py) β…
   - /metrics/report/{plan_id}/text (report.py) β μ¶©λ
   ```

## β… μμ • λ‚΄μ©

### 1. `app/routers/metrics.py` μμ •

**μ κ±°λ λ‚΄μ©:**
- `/report/{plan_id}/text` GET μ—”λ“ν¬μΈνΈ
- `/report/{plan_id}/text` POST μ—”λ“ν¬μΈνΈ
- `_assert_plan_state` ν—¬νΌ ν•¨μ
- λ¶ν•„μ”ν• import λ¬Έ (`Optional`, `has_plan_dir`, `iter_metrics`, `compute_summary`, `summary_to_text`)

**μ μ§€λ λ‚΄μ©:**
- `POST /analyze` μ—”λ“ν¬μΈνΈ (λ©”νΈλ¦­ λ°μ΄ν„° μμ§‘ λ° λ¶„μ„μ©)

**μμ • μ „ (60μ¤„) β†’ μμ • ν›„ (32μ¤„)**

### 2. `app/routers/report.py` μμ •

**μ κ±°λ λ‚΄μ©:**
- μ¤‘λ³µ μ •μλ `compute_summary` ν•¨μ (59-93λ² μ¤„)
  - μ΄ ν•¨μλ” μ΄λ―Έ `app.services.report_service`μ—μ„ importλκ³  μμ—μ

**μ μ§€λ λ‚΄μ©:**
- `GET /report/{plan_id}` - λ¦¬ν¬νΈ μƒμ„± λ° μ €μ¥
- `GET /report/{plan_id}/text` - ν…μ¤νΈ λ¦¬ν¬νΈ μ΅°ν
- `POST /report/{plan_id}/text` - μ»¤μ¤ν…€ ν…μ¤νΈ λ¦¬ν¬νΈ μƒμ„±
- `TextOptions` Pydantic λ¨λΈ
- `_assert_ready_or_409` ν—¬νΌ ν•¨μ

**μμ • μ „ (93μ¤„) β†’ μμ • ν›„ (57μ¤„)**

## π“ μµμΆ… μ—”λ“ν¬μΈνΈ κµ¬μ΅°

### Metrics Router (`/metrics` prefix)
```
POST /metrics/analyze
```
- λ©”νΈλ¦­ λ°μ΄ν„° λ¶„μ„ λ° μ €μ¥
- μ μ κ³„μ‚° λ° μ”μ•½ λ°ν™

### Report Router (`/metrics` prefix)
```
GET  /metrics/report/{plan_id}
GET  /metrics/report/{plan_id}/text
POST /metrics/report/{plan_id}/text
```
- **GET /metrics/report/{plan_id}**: μ „μ²΄ λ¦¬ν¬νΈ μƒμ„± λ° JSON νμΌλ΅ μ €μ¥
- **GET /metrics/report/{plan_id}/text**: κΈ°λ³Έ ν…μ¤νΈ λ¦¬ν¬νΈ μ΅°ν (rules λ¨λ“)
- **POST /metrics/report/{plan_id}/text**: μ»¤μ¤ν…€ ν…μ¤νΈ λ¦¬ν¬νΈ μƒμ„±
  - μµμ…: `mode` (rules/prompt/llm), `style`, `notes`, `seed`, `name_map`

## π”§ κΈ°μ μ  κ°μ„  μ‚¬ν•­

### 1. λ‹¨μΌ μ±…μ„ μ›μΉ™ (SRP) μ¤€μ
- **metrics.py**: λ©”νΈλ¦­ λ°μ΄ν„° μμ§‘ λ° μ¦‰μ‹ λ¶„μ„
- **report.py**: μμ§‘λ λ°μ΄ν„°μ λ¦¬ν¬νΈ μƒμ„± λ° μ΅°ν
- **report_service.py**: λΉ„μ¦λ‹μ¤ λ΅μ§ (μ§‘κ³„, ν…μ¤νΈ μƒμ„±)

### 2. μ½”λ“ μ¤‘λ³µ μ κ±° (DRY)
- `compute_summary` ν•¨μλ” `report_service.py`μ—λ§ μ΅΄μ¬
- λ¨λ“  λΌμ°ν„°λ” μ„λΉ„μ¤ λ μ΄μ–΄μ ν•¨μλ¥Ό μ¬μ‚¬μ©
- μ¤‘λ³µ import μ κ±°λ΅ μμ΅΄μ„± λ…ν™•ν™”

### 3. λ…ν™•ν• λΌμ°ν…
- κ° μ—”λ“ν¬μΈνΈκ°€ κ³ μ ν• κ²½λ΅λ¥Ό κ°€μ§
- μ¶©λ μ—†μ΄ λ¨λ“  κΈ°λ¥ μ ‘κ·Ό κ°€λ¥
- RESTful μ„¤κ³„ μ›μΉ™ μ¤€μ

## π“ ν…μ¤νΈ κ¶μ¥ μ‚¬ν•­

μμ • ν›„ λ‹¤μ μ—”λ“ν¬μΈνΈλ“¤μ„ ν…μ¤νΈν•΄λ³΄μ„Έμ”:

### 1. λ©”νΈλ¦­ λ°μ΄ν„° μ „μ†΅
```bash
POST http://localhost:8001/metrics/analyze
Content-Type: application/json

{
  "plan_id": 1,
  "member_id": 123,
  "distance_km": 5.2,
  "travel_minutes": 25,
  "late_minutes": 0,
  "wait_minutes": 5
}
```

### 2. μ „μ²΄ λ¦¬ν¬νΈ μ΅°ν
```bash
GET http://localhost:8001/metrics/report/1
```

### 3. ν…μ¤νΈ λ¦¬ν¬νΈ μ΅°ν (κΈ°λ³Έ)
```bash
GET http://localhost:8001/metrics/report/1/text
```

### 4. μ»¤μ¤ν…€ ν…μ¤νΈ λ¦¬ν¬νΈ μƒμ„±
```bash
POST http://localhost:8001/metrics/report/1/text
Content-Type: application/json

{
  "mode": "prompt",
  "style": "μΉκ·Όν•",
  "notes": "κ²©λ ¤ ν†¤μΌλ΅",
  "name_map": {
    "123": "ν™κΈΈλ™",
    "456": "κΉ€μ² μ"
  }
}
```

## π“… μ‘μ—… μ •λ³΄

- **μ‘μ—… λ‚ μ§**: 2025-11-20
- **μμ • νμΌ**:
  - `app/routers/metrics.py` (60μ¤„ β†’ 32μ¤„)
  - `app/routers/report.py` (93μ¤„ β†’ 57μ¤„)
- **μ΄ μ½”λ“ κ°μ†**: 64μ¤„ (μ•½ 42% κ°μ†)

## π― κΈ°λ€ ν¨κ³Ό

1. **λΌμ°ν… μ¶©λ ν•΄κ²°**: `/metrics/report/{planId}` μ—”λ“ν¬μΈνΈκ°€ μ •μƒ λ™μ‘
2. **μ μ§€λ³΄μμ„± ν–¥μƒ**: μ½”λ“ μ¤‘λ³µ μ κ±°λ΅ μμ • ν¬μΈνΈ λ‹¨μΌν™”
3. **κ°€λ…μ„± κ°μ„ **: κ° νμΌμ μ—­ν• μ΄ λ…ν™•ν•΄μ§
4. **ν™•μ¥μ„± ν–¥μƒ**: μƒλ΅μ΄ κΈ°λ¥ μ¶”κ°€ μ‹ μ¶©λ μ„ν— κ°μ†
