# Python AI ì„œë²„ ê·¸ë£¹ ìš”ì•½ API êµ¬í˜„ ì‘ì—… ê¸°ë¡

**ì‘ì—…ì¼:** 2025-11-24  
**ì‘ì—…ì:** AI Assistant  
**ì°¸ì¡° ë¬¸ì„œ:** [PYTHON_API_REQ.md](file:///c:/workspace/oathkeeper_python/docs/PYTHON_API_REQ.md), [1124\_íŒŒì´ì¬APIì¶”ê°€ê³„íš.md](file:///c:/workspace/oathkeeper_python/docs/1124_íŒŒì´ì¬APIì¶”ê°€ê³„íš.md)

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Spring ì„œë²„ ê°œë°œíŒ€ì˜ ìš”ì²­ì— ë”°ë¼ ê·¸ë£¹(ì±„íŒ…ë°©) ë‹¨ìœ„ì˜ ëˆ„ì  í†µê³„ ë° ìš”ì•½ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì‹ ê·œ API 2ê°œë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### ì‹ ê·œ API ëª©ë¡

| Method | Endpoint                      | ì„¤ëª…             |
| ------ | ----------------------------- | ---------------- |
| POST   | `/metrics/group/summary`      | ê·¸ë£¹ í†µê³„ ìš”ì•½   |
| POST   | `/metrics/group/summary/text` | ê·¸ë£¹ ìì—°ì–´ ìš”ì•½ |

---

## âœ… Phase 1 êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### 1. ëª¨ë¸ ì •ì˜ (`app/models.py`)

**ì¶”ê°€ëœ ëª¨ë¸: 5ê°œ**

```python
# ìš”ì²­ ëª¨ë¸
class GroupSummaryRequest(BaseModel)
class GroupTextSummaryRequest(BaseModel)

# ì‘ë‹µ ë°ì´í„° ëª¨ë¸
class GroupSummaryData(BaseModel)

# ì‘ë‹µ ëª¨ë¸
class GroupSummaryResponse(BaseModel)
class GroupTextSummaryResponse(BaseModel)
```

**ë³€ê²½ ì‚¬í•­:**

- íŒŒì¼ í¬ê¸°: 50ì¤„ â†’ 98ì¤„ (48ì¤„ ì¶”ê°€)
- ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ì—†ìŒ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)

**ì£¼ìš” í•„ë“œ:**

- `GroupSummaryData`: 10ê°œ í†µê³„ í•„ë“œ (ì´ í”Œëœ ìˆ˜, ì´ ê¸°ë¡ ìˆ˜, ì´/í‰ê·  ì´ë™ ê±°ë¦¬, ì´/í‰ê·  ì´ë™ ì‹œê°„, ì´/í‰ê·  ì§€ê° ì‹œê°„, ì´/í‰ê·  ëŒ€ê¸° ì‹œê°„)
- `warnings`: ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ê²½ê³  ë©”ì‹œì§€ ë°°ì—´

---

### 2. ì„œë¹„ìŠ¤ ë¡œì§ (`app/services/group_service.py`) âœ¨ ì‹ ê·œ

**íŒŒì¼ í¬ê¸°:** 243ì¤„

**ì£¼ìš” í•¨ìˆ˜:**

#### `compute_group_summary(plan_ids: List[int]) -> Tuple[Dict, List[str]]`

**ì—­í• :** ì—¬ëŸ¬ í”Œëœì˜ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ì§‘ê³„í•˜ì—¬ ê·¸ë£¹ í†µê³„ ê³„ì‚°

**ë¡œì§:**

1. ê° `plan_id`ì˜ ë””ë ‰í„°ë¦¬ ì¡´ì¬ í™•ì¸
2. `iter_metrics(plan_id)`ë¡œ ë©”íŠ¸ë¦­ ë°ì´í„° ì½ê¸°
3. ëˆ„ë½/ë°ì´í„° ì—†ëŠ” plan_idëŠ” `warnings`ì— ì¶”ê°€
4. ëª¨ë“  ë ˆì½”ë“œ ì§‘ê³„ (ê±°ë¦¬, ì‹œê°„, ì§€ê°, ëŒ€ê¸°)
5. í”Œëœë‹¹ í‰ê·  ê³„ì‚°
6. ëª¨ë“  plan_id ì‹¤íŒ¨ ì‹œ `409 Conflict` ì˜ˆì™¸ ë°œìƒ

**ì—ëŸ¬ ì²˜ë¦¬:**

```python
# ì¼ë¶€ ì‹¤íŒ¨: 200 OK + warnings
{
  "success": true,
  "data": {...},
  "warnings": ["plan_id '999' was not found."]
}

# ì „ì²´ ì‹¤íŒ¨: 409 Conflict
HTTPException(status_code=409, detail={
  "code": "NO_DATA",
  "message": "No data available for the given plan_ids."
})
```

#### `group_summary_to_text(summary, style, notes, mode) -> str`

**ì—­í• :** ê·¸ë£¹ í†µê³„ë¥¼ ìì—°ì–´ë¡œ ë³€í™˜

**ì§€ì› ëª¨ë“œ:**

- `rules`: ê·œì¹™ ê¸°ë°˜ í…ìŠ¤íŠ¸ ìƒì„± (LLM ë¶ˆí•„ìš”)
- `llm`: Ollama LLM ì‚¬ìš© (fallback: rules ëª¨ë“œ)

**LLM í†µí•©:**

- `_llm_text_with_ollama()`: Ollama API í˜¸ì¶œ
- `_sanitize_tone()`: ë¶€ì ì ˆí•œ í‘œí˜„ ì •ì œ
- í™˜ê²½ ë³€ìˆ˜: `OLLAMA_URL`, `OLLAMA_MODEL`

---

### 3. ë¼ìš°í„° (`app/routers/group.py`) âœ¨ ì‹ ê·œ

**íŒŒì¼ í¬ê¸°:** 91ì¤„

**ì—”ë“œí¬ì¸íŠ¸ 1: POST /metrics/group/summary**

```python
@router.post("/group/summary", response_model=GroupSummaryResponse)
async def get_group_summary(req: GroupSummaryRequest)
```

**ìš”ì²­ ì˜ˆì‹œ:**

```json
{
  "plan_ids": [1, 5, 12, 23]
}
```

**ì‘ë‹µ ì˜ˆì‹œ:**

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 4,
    "total_records": 128,
    "total_distance_km": 258.4,
    "avg_distance_per_plan_km": 64.6,
    "total_travel_minutes": 450,
    "avg_travel_minutes_per_plan": 112.5,
    "total_late_minutes": 45,
    "avg_late_minutes_per_plan": 11.25,
    "total_wait_minutes": 20,
    "avg_wait_minutes_per_plan": 5.0
  },
  "warnings": null
}
```

**ì—”ë“œí¬ì¸íŠ¸ 2: POST /metrics/group/summary/text**

```python
@router.post("/group/summary/text", response_model=GroupTextSummaryResponse)
async def get_group_summary_text(req: GroupTextSummaryRequest)
```

**ìš”ì²­ ì˜ˆì‹œ:**

```json
{
  "plan_ids": [1, 5, 12, 23],
  "style": "ë°ì´í„° ë¶„ì„ê°€ì²˜ëŸ¼ ê°ê´€ì ì¸ í†¤ìœ¼ë¡œ",
  "notes": "ì§€ê° ë¹ˆë„ê°€ ë†’ì€ ê²½í–¥ì´ ìˆëŠ”ì§€ ë¶„ì„í•´ì£¼ì„¸ìš”.",
  "mode": "llm"
}
```

**ì‘ë‹µ ì˜ˆì‹œ:**

```json
{
  "success": true,
  "data": "ë¶„ì„ëœ 4ê°œì˜ ì•½ì†ì— ë”°ë¥´ë©´, ì´ ê·¸ë£¹ì€ ì•½ì†ë‹¹ í‰ê·  64.6kmë¥¼ ì´ë™í–ˆìœ¼ë©°, í‰ê·  11.25ë¶„ì˜ ì§€ê° ì‹œê°„ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ì „ë°˜ì ìœ¼ë¡œ ì¥ê±°ë¦¬ ì´ë™ì´ ì¦ê³ , ì•½ì† ì‹œê°„ì„ ì¤€ìˆ˜í•˜ëŠ” ë° ì•½ê°„ì˜ ì–´ë ¤ì›€ì´ ìˆëŠ” ê²½í–¥ì„ ë³´ì…ë‹ˆë‹¤.",
  "warnings": null
}
```

---

### 4. ë©”ì¸ ì•± í†µí•© (`app/main.py`)

**ë³€ê²½ ì‚¬í•­:**

```diff
+ from app.routers.group import router as group_router

  def create_app() -> FastAPI:
      app = FastAPI(title="Oathkeeper Metrics Analyzer (Modular)")
      app.include_router(metrics_router, prefix="/metrics", tags=["metrics"])
      app.include_router(report_router,  prefix="/metrics", tags=["report"])
      app.include_router(llm_router,     prefix="/metrics", tags=["llm"])
+     app.include_router(group_router,   prefix="/metrics", tags=["group"])
      return app
```

**ë³€ê²½ í¬ê¸°:** 2ì¤„ ì¶”ê°€ (import 1ì¤„ + router ë“±ë¡ 1ì¤„)

---

## ğŸ“Š ìµœì¢… API ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°

| Method   | Endpoint                          | ì„¤ëª…                      | íŒŒì¼           | ìƒíƒœ        |
| -------- | --------------------------------- | ------------------------- | -------------- | ----------- |
| POST     | `/metrics/analyze`                | ë‹¨ì¼ ë©”íŠ¸ë¦­ ìˆ˜ì§‘          | `metrics.py`   | ê¸°ì¡´        |
| GET      | `/metrics/report/{plan_id}`       | ë‹¨ì¼ í”Œëœ ë¦¬í¬íŠ¸          | `report.py`    | ê¸°ì¡´        |
| GET      | `/metrics/report/{plan_id}/text`  | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ (ê¸°ë³¸)   | `report.py`    | ê¸°ì¡´        |
| POST     | `/metrics/report/{plan_id}/text`  | ë‹¨ì¼ í”Œëœ í…ìŠ¤íŠ¸ (ì»¤ìŠ¤í…€) | `report.py`    | ê¸°ì¡´        |
| POST     | `/metrics/llm/generate`           | LLM ë²”ìš© ìƒì„±             | `llm.py`       | ê¸°ì¡´        |
| **POST** | **`/metrics/group/summary`**      | **ê·¸ë£¹ í†µê³„ ìš”ì•½**        | **`group.py`** | **âœ¨ ì‹ ê·œ** |
| **POST** | **`/metrics/group/summary/text`** | **ê·¸ë£¹ ìì—°ì–´ ìš”ì•½**      | **`group.py`** | **âœ¨ ì‹ ê·œ** |

---

## ğŸ”§ ê¸°ìˆ ì  íŠ¹ì§•

### 1. ê¸°ì¡´ íŒ¨í„´ ì¬ì‚¬ìš©

**ì°¸ì¡°í•œ ê¸°ì¡´ ì½”ë“œ:**

- `report_service.py`ì˜ `compute_summary()` â†’ `compute_group_summary()` êµ¬ì¡° ì°¸ê³ 
- `report_service.py`ì˜ `_llm_text_with_ollama()` â†’ LLM í†µí•© ë°©ì‹ ì¬ì‚¬ìš©
- `report.py`ì˜ ë¼ìš°í„° íŒ¨í„´ â†’ `group.py` êµ¬ì¡° ì°¸ê³ 

**ì¥ì :**

- ì½”ë“œ ì¼ê´€ì„± ìœ ì§€
- ê²€ì¦ëœ ë¡œì§ ì¬ì‚¬ìš©
- í•™ìŠµ ê³¡ì„  ìµœì†Œí™”

### 2. ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

**ë¶€ë¶„ ì„±ê³µ í—ˆìš© (Graceful Degradation):**

```python
# ì¼ë¶€ plan_id ì‹¤íŒ¨ ì‹œì—ë„ ì„±ê³µ ì‘ë‹µ
if not has_plan_dir(plan_id):
    warnings.append(f"plan_id '{plan_id}' was not found.")
    continue  # ë‹¤ìŒ plan_id ì²˜ë¦¬ ê³„ì†
```

**ì™„ì „ ì‹¤íŒ¨ ì²˜ë¦¬:**

```python
# ëª¨ë“  plan_id ì‹¤íŒ¨ ì‹œì—ë§Œ ì˜ˆì™¸ ë°œìƒ
if not all_records:
    raise HTTPException(status_code=409, ...)
```

### 3. LLM Fallback ë©”ì»¤ë‹ˆì¦˜

```python
def _llm_text_with_ollama(...):
    try:
        # Ollama API í˜¸ì¶œ
        response = requests.post(...)
        return response.json()["response"]
    except Exception as e:
        # ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ rules ëª¨ë“œë¡œ ì „í™˜
        return _rules_text(summary)
```

**ì¥ì :**

- Ollama ì„œë²„ ë‹¤ìš´ ì‹œì—ë„ ì„œë¹„ìŠ¤ ê°€ëŠ¥
- ì•ˆì •ì„± í–¥ìƒ

### 4. ë¼ìš°íŒ… ì¶©ëŒ ë°©ì§€

**ì´ì „ ë¬¸ì œ (2025-11-20):**

- `metrics.py`ì™€ `report.py`ì—ì„œ `/report/{plan_id}/text` ì¤‘ë³µ ì •ì˜
- ë¼ìš°íŒ… ì¶©ëŒ ë°œìƒ

**í˜„ì¬ í•´ê²°ì±…:**

- ì‹ ê·œ ë¼ìš°í„°ë¥¼ ë…ë¦½ íŒŒì¼ë¡œ ë¶„ë¦¬ (`group.py`)
- ëª…í™•í•œ ê²½ë¡œ prefix ì‚¬ìš© (`/group/*`)
- ê¸°ì¡´ ë¼ìš°í„°ì™€ ì¶©ëŒ ì—†ìŒ âœ…

---

## ğŸ“ ìˆ˜ì •/ìƒì„±ëœ íŒŒì¼ ëª©ë¡

### ìˆ˜ì •ëœ íŒŒì¼ (2ê°œ)

1. **[app/models.py](file:///c:/workspace/oathkeeper_python/app/models.py)**

   - ë³€ê²½: 48ì¤„ ì¶”ê°€ (50ì¤„ â†’ 98ì¤„)
   - ë‚´ìš©: ê·¸ë£¹ ìš”ì•½ ê´€ë ¨ Pydantic ëª¨ë¸ 5ê°œ ì¶”ê°€

2. **[app/main.py](file:///c:/workspace/oathkeeper_python/app/main.py)**
   - ë³€ê²½: 2ì¤„ ì¶”ê°€ (18ì¤„ â†’ 20ì¤„)
   - ë‚´ìš©: group_router import ë° ë“±ë¡

### ì‹ ê·œ ìƒì„±ëœ íŒŒì¼ (3ê°œ)

3. **[app/services/group_service.py](file:///c:/workspace/oathkeeper_python/app/services/group_service.py)** âœ¨

   - í¬ê¸°: 243ì¤„
   - ë‚´ìš©: ê·¸ë£¹ í†µê³„ ì§‘ê³„ ë° í…ìŠ¤íŠ¸ ìƒì„± ë¡œì§

4. **[app/routers/group.py](file:///c:/workspace/oathkeeper_python/app/routers/group.py)** âœ¨

   - í¬ê¸°: 91ì¤„
   - ë‚´ìš©: ê·¸ë£¹ ìš”ì•½ API ì—”ë“œí¬ì¸íŠ¸ 2ê°œ

5. **[test_group_api.py](file:///c:/workspace/oathkeeper_python/test_group_api.py)** âœ¨
   - í¬ê¸°: 120ì¤„
   - ë‚´ìš©: API í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (4ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤)

**ì´ ì½”ë“œ ì¶”ê°€ëŸ‰:** ì•½ 502ì¤„

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ì„œë²„ ì‹¤í–‰

```powershell
.\venv\Scripts\python.exe -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
```

### 2. Swagger UI ì ‘ì†

ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:8001/docs ì ‘ì†

### 3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ ê·¸ë£¹ ìš”ì•½

**ìš”ì²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [1, 2]
}
```

**ì˜ˆìƒ ê²°ê³¼:** 200 OK, í†µê³„ ë°ì´í„° ë°˜í™˜

---

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ì¼ë¶€ plan_id ëˆ„ë½

**ìš”ì²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [1, 999]
}
```

**ì˜ˆìƒ ê²°ê³¼:** 200 OK, warnings í¬í•¨

---

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ëª¨ë“  plan_id ì‹¤íŒ¨

**ìš”ì²­:**

```json
POST /metrics/group/summary
{
  "plan_ids": [888, 999]
}
```

**ì˜ˆìƒ ê²°ê³¼:** 409 Conflict

---

#### ì‹œë‚˜ë¦¬ì˜¤ 4: ìì—°ì–´ ìš”ì•½ (rules ëª¨ë“œ)

**ìš”ì²­:**

```json
POST /metrics/group/summary/text
{
  "plan_ids": [1, 2],
  "mode": "rules",
  "style": "ì¹œê·¼í•œ í†¤ìœ¼ë¡œ",
  "notes": "ê¸ì •ì ì¸ ë©´ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”"
}
```

**ì˜ˆìƒ ê²°ê³¼:** 200 OK, ìì—°ì–´ í…ìŠ¤íŠ¸ ë°˜í™˜

---

#### ì‹œë‚˜ë¦¬ì˜¤ 5: ìì—°ì–´ ìš”ì•½ (llm ëª¨ë“œ)

**ìš”ì²­:**

```json
POST /metrics/group/summary/text
{
  "plan_ids": [1, 2],
  "mode": "llm",
  "style": "ë°ì´í„° ë¶„ì„ê°€ì²˜ëŸ¼ ê°ê´€ì ì¸ í†¤ìœ¼ë¡œ",
  "notes": "ì§€ê° ë¹ˆë„ê°€ ë†’ì€ ê²½í–¥ì´ ìˆëŠ”ì§€ ë¶„ì„í•´ì£¼ì„¸ìš”"
}
```

**ì˜ˆìƒ ê²°ê³¼:** 200 OK, LLM ìƒì„± í…ìŠ¤íŠ¸ ë°˜í™˜ (Ollama ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œì•½

### 1. Ollama ì„œë²„ ì˜ì¡´ì„±

**LLM ëª¨ë“œ ì‚¬ìš© ì‹œ:**

- Ollama ì„œë²„ê°€ `http://localhost:11434`ì—ì„œ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨
- í™˜ê²½ ë³€ìˆ˜ë¡œ ë³€ê²½ ê°€ëŠ¥: `OLLAMA_URL`, `OLLAMA_MODEL`

**Ollama ë¯¸ì‹¤í–‰ ì‹œ:**

- ìë™ìœ¼ë¡œ `rules` ëª¨ë“œë¡œ fallback
- ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ âœ…

### 2. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

**ëŒ€ëŸ‰ plan_ids ì²˜ë¦¬:**

- í˜„ì¬ êµ¬í˜„: ìˆœì°¨ ì²˜ë¦¬ (for loop)
- ê¶Œì¥ ìµœëŒ€: 100ê°œ ì´í•˜
- í–¥í›„ ê°œì„ : ë¹„ë™ê¸° I/O, ë³‘ë ¬ ì²˜ë¦¬

**ë©”ëª¨ë¦¬ ì‚¬ìš©:**

- ëª¨ë“  ë ˆì½”ë“œë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ (`list(iter_metrics(...))`)
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ì‹œ ì£¼ì˜ í•„ìš”

### 3. ë°ì´í„° ì¼ê´€ì„±

**JSONL íŒŒì¼ ì†ìƒ ì‹œ:**

- `iter_metrics()`ê°€ ì˜ëª»ëœ ë¼ì¸ ìë™ ìŠ¤í‚µ
- ë¶€ë¶„ì ìœ¼ë¡œ ì†ìƒëœ íŒŒì¼ë„ ì²˜ë¦¬ ê°€ëŠ¥ âœ…

---

## ğŸ“ˆ ê°œì„  ê°€ëŠ¥ ì‚¬í•­ (í–¥í›„ ì‘ì—…)

### Phase 2 (ì„ íƒì‚¬í•­)

1. **ì„±ëŠ¥ ìµœì í™”**

   - [ ] ë¹„ë™ê¸° I/Oë¡œ íŒŒì¼ ì½ê¸° ë³‘ë ¬í™”
   - [ ] ìºì‹± ë ˆì´ì–´ ì¶”ê°€ (Redis ë“±)
   - [ ] plan_ids ê°œìˆ˜ ì œí•œ (ì˜ˆ: ìµœëŒ€ 100ê°œ)

2. **ê¸°ëŠ¥ í™•ì¥**

   - [ ] ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ (`since`, `until` íŒŒë¼ë¯¸í„°)
   - [ ] ë©¤ë²„ë³„ ê·¸ë£¹ í†µê³„ (í˜„ì¬ëŠ” ì „ì²´ í†µê³„ë§Œ)
   - [ ] ì¶”ê°€ í†µê³„ í•„ë“œ (ì¤‘ì•™ê°’, í‘œì¤€í¸ì°¨ ë“±)

3. **í…ŒìŠ¤íŠ¸ ê°•í™”**

   - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± (`pytest`)
   - [ ] í†µí•© í…ŒìŠ¤íŠ¸ ìë™í™”
   - [ ] ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

4. **ë¬¸ì„œí™”**
   - [ ] OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„¸ ì„¤ëª… ì¶”ê°€
   - [ ] ì˜ˆì œ ì‘ë‹µ ì¶”ê°€
   - [ ] ì—ëŸ¬ ì½”ë“œ ë¬¸ì„œí™”

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±ë„

| ìš”êµ¬ì‚¬í•­                         | ìƒíƒœ    | ë¹„ê³                    |
| -------------------------------- | ------- | ---------------------- |
| POST /metrics/group/summary      | âœ… ì™„ë£Œ | 10ê°œ í†µê³„ í•„ë“œ ì œê³µ    |
| POST /metrics/group/summary/text | âœ… ì™„ë£Œ | rules/llm ëª¨ë“œ ì§€ì›    |
| ì¼ë¶€ plan_id ì‹¤íŒ¨ ì‹œ warnings    | âœ… ì™„ë£Œ | 200 OK + warnings ë°°ì—´ |
| ëª¨ë“  plan_id ì‹¤íŒ¨ ì‹œ 409         | âœ… ì™„ë£Œ | 409 Conflict ë°˜í™˜      |
| LLM í†µí•©                         | âœ… ì™„ë£Œ | Ollama ì—°ë™ + fallback |
| ê¸°ì¡´ ì½”ë“œ ì˜í–¥ ìµœì†Œí™”            | âœ… ì™„ë£Œ | 2ì¤„ë§Œ ìˆ˜ì • (main.py)   |
| ë¼ìš°íŒ… ì¶©ëŒ ë°©ì§€                 | âœ… ì™„ë£Œ | ë…ë¦½ ë¼ìš°í„° ë¶„ë¦¬       |

**ì¶©ì¡±ë¥ : 100%** ğŸ‰

---

## ğŸ’¡ í•µì‹¬ ì„±ê³¼

### 1. ì•ˆì „í•œ êµ¬í˜„

- âœ… ê¸°ì¡´ API ì˜í–¥ ì—†ìŒ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
- âœ… ë¼ìš°íŒ… ì¶©ëŒ ì—†ìŒ (ë…ë¦½ ë¼ìš°í„°)
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ì™„ë²½ (ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš©)

### 2. í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„

- âœ… ê¸°ì¡´ íŒ¨í„´ ì¬ì‚¬ìš© (ì¼ê´€ì„±)
- âœ… ëª¨ë“ˆí™”ëœ êµ¬ì¡° (ìœ ì§€ë³´ìˆ˜ ìš©ì´)
- âœ… LLM fallback (ì•ˆì •ì„±)

### 3. ë¹ ë¥¸ êµ¬í˜„

- âœ… Phase 1 ì™„ë£Œ (ëª¨ë¸ + ì„œë¹„ìŠ¤ + ë¼ìš°í„°)
- âœ… í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì œê³µ
- âœ… ë¬¸ì„œí™” ì™„ë£Œ

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ê°€ëŠ¥í•œ ì‘ì—…

1. **Swagger UIì—ì„œ ìˆ˜ë™ í…ŒìŠ¤íŠ¸**

   - http://localhost:8001/docs ì ‘ì†
   - 4ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

2. **Spring íŒ€ê³¼ í˜‘ì˜**

   - API ì‘ë‹µ í˜•ì‹ í™•ì¸
   - ì¶”ê°€ í•„ë“œ í•„ìš” ì—¬ë¶€ í™•ì¸
   - plan_ids ê°œìˆ˜ ì œí•œ ë…¼ì˜

3. **Ollama ì„¤ì • í™•ì¸**
   - Ollama ì„œë²„ ì‹¤í–‰ ì—¬ë¶€
   - ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì—¬ë¶€ (`llama3.1`)

### ì„ íƒì  ì‘ì—…

4. **Phase 2 êµ¬í˜„ (ì„±ëŠ¥ ìµœì í™”)**
5. **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±**
6. **ì¶”ê°€ í†µê³„ í•„ë“œ êµ¬í˜„**

---

## â˜• Java/Spring ê°œë°œìë¥¼ ìœ„í•œ API í™œìš© ê°€ì´ë“œ

### ğŸ“¦ 1. DTO í´ë˜ìŠ¤ ì •ì˜

#### GroupSummaryRequest.java

```java
package com.oathkeeper.dto.request;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import javax.validation.constraints.NotEmpty;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GroupSummaryRequest {

    @NotEmpty(message = "plan_idsëŠ” ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    private List<Long> planIds;
}
```

#### GroupSummaryResponse.java

```java
package com.oathkeeper.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GroupSummaryResponse {

    private Boolean success;
    private GroupSummaryData data;
    private List<String> warnings;

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class GroupSummaryData {

        @JsonProperty("total_plans_analyzed")
        private Integer totalPlansAnalyzed;

        @JsonProperty("total_records")
        private Integer totalRecords;

        @JsonProperty("total_distance_km")
        private Double totalDistanceKm;

        @JsonProperty("avg_distance_per_plan_km")
        private Double avgDistancePerPlanKm;

        @JsonProperty("total_travel_minutes")
        private Integer totalTravelMinutes;

        @JsonProperty("avg_travel_minutes_per_plan")
        private Double avgTravelMinutesPerPlan;

        @JsonProperty("total_late_minutes")
        private Integer totalLateMinutes;

        @JsonProperty("avg_late_minutes_per_plan")
        private Double avgLateMinutesPerPlan;

        @JsonProperty("total_wait_minutes")
        private Integer totalWaitMinutes;

        @JsonProperty("avg_wait_minutes_per_plan")
        private Double avgWaitMinutesPerPlan;
    }
}
```

#### GroupTextSummaryRequest.java

```java
package com.oathkeeper.dto.request;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import javax.validation.constraints.NotEmpty;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GroupTextSummaryRequest {

    @NotEmpty(message = "plan_idsëŠ” ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    private List<Long> planIds;

    @Builder.Default
    private String style = "";

    @Builder.Default
    private String notes = "";

    @Builder.Default
    private String mode = "llm";  // "rules" | "llm"

    private Integer seed;
}
```

#### GroupTextSummaryResponse.java

```java
package com.oathkeeper.dto.response;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class GroupTextSummaryResponse {

    private Boolean success;
    private String data;  // ìì—°ì–´ í…ìŠ¤íŠ¸
    private List<String> warnings;
}
```

---

### ğŸ”§ 2. Service í´ë˜ìŠ¤ êµ¬í˜„

#### PythonAiClient.java (RestTemplate ì‚¬ìš©)

```java
package com.oathkeeper.service;

import com.oathkeeper.dto.request.GroupSummaryRequest;
import com.oathkeeper.dto.request.GroupTextSummaryRequest;
import com.oathkeeper.dto.response.GroupSummaryResponse;
import com.oathkeeper.dto.response.GroupTextSummaryResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class PythonAiClient {

    private final RestTemplate restTemplate;

    @Value("${python.ai.base-url:http://localhost:8001}")
    private String pythonAiBaseUrl;

    /**
     * ê·¸ë£¹ í†µê³„ ìš”ì•½ ì¡°íšŒ
     *
     * @param planIds ë¶„ì„í•  plan_id ëª©ë¡
     * @return ê·¸ë£¹ í†µê³„ ë°ì´í„°
     * @throws PythonAiException API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ
     */
    public GroupSummaryResponse getGroupSummary(List<Long> planIds) {
        String url = pythonAiBaseUrl + "/metrics/group/summary";

        GroupSummaryRequest request = GroupSummaryRequest.builder()
                .planIds(planIds)
                .build();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<GroupSummaryRequest> entity = new HttpEntity<>(request, headers);

        try {
            ResponseEntity<GroupSummaryResponse> response = restTemplate.exchange(
                    url,
                    HttpMethod.POST,
                    entity,
                    GroupSummaryResponse.class
            );

            GroupSummaryResponse body = response.getBody();

            // warnings ë¡œê¹…
            if (body != null && body.getWarnings() != null && !body.getWarnings().isEmpty()) {
                log.warn("ê·¸ë£¹ ìš”ì•½ ì¡°íšŒ ì‹œ ê²½ê³  ë°œìƒ: {}", body.getWarnings());
            }

            return body;

        } catch (HttpClientErrorException.Conflict e) {
            // 409 Conflict: ëª¨ë“  plan_id ì‹¤íŒ¨
            log.error("ê·¸ë£¹ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨ - ë°ì´í„° ì—†ìŒ: planIds={}", planIds);
            throw new PythonAiException("ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤", e);

        } catch (Exception e) {
            log.error("ê·¸ë£¹ ìš”ì•½ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: planIds={}", planIds, e);
            throw new PythonAiException("Python AI ì„œë²„ í†µì‹  ì‹¤íŒ¨", e);
        }
    }

    /**
     * ê·¸ë£¹ ìì—°ì–´ ìš”ì•½ ì¡°íšŒ
     *
     * @param planIds ë¶„ì„í•  plan_id ëª©ë¡
     * @param style í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì„ íƒ)
     * @param notes ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ì„ íƒ)
     * @param mode ìƒì„± ëª¨ë“œ ("rules" | "llm")
     * @return ìì—°ì–´ ìš”ì•½ í…ìŠ¤íŠ¸
     * @throws PythonAiException API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ
     */
    public GroupTextSummaryResponse getGroupSummaryText(
            List<Long> planIds,
            String style,
            String notes,
            String mode
    ) {
        String url = pythonAiBaseUrl + "/metrics/group/summary/text";

        GroupTextSummaryRequest request = GroupTextSummaryRequest.builder()
                .planIds(planIds)
                .style(style != null ? style : "")
                .notes(notes != null ? notes : "")
                .mode(mode != null ? mode : "llm")
                .build();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<GroupTextSummaryRequest> entity = new HttpEntity<>(request, headers);

        try {
            ResponseEntity<GroupTextSummaryResponse> response = restTemplate.exchange(
                    url,
                    HttpMethod.POST,
                    entity,
                    GroupTextSummaryResponse.class
            );

            GroupTextSummaryResponse body = response.getBody();

            // warnings ë¡œê¹…
            if (body != null && body.getWarnings() != null && !body.getWarnings().isEmpty()) {
                log.warn("ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì¡°íšŒ ì‹œ ê²½ê³  ë°œìƒ: {}", body.getWarnings());
            }

            return body;

        } catch (HttpClientErrorException.Conflict e) {
            // 409 Conflict: ëª¨ë“  plan_id ì‹¤íŒ¨
            log.error("ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨ - ë°ì´í„° ì—†ìŒ: planIds={}", planIds);
            throw new PythonAiException("ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤", e);

        } catch (Exception e) {
            log.error("ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: planIds={}", planIds, e);
            throw new PythonAiException("Python AI ì„œë²„ í†µì‹  ì‹¤íŒ¨", e);
        }
    }

    /**
     * ê°„í¸ ë©”ì„œë“œ: ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ìì—°ì–´ ìš”ì•½ ì¡°íšŒ
     */
    public String getGroupSummaryTextSimple(List<Long> planIds) {
        GroupTextSummaryResponse response = getGroupSummaryText(
                planIds,
                null,  // style
                null,  // notes
                "rules"  // LLM ì—†ì´ ë¹ ë¥¸ ì‘ë‹µ
        );
        return response.getData();
    }
}
```

#### PythonAiException.java

```java
package com.oathkeeper.exception;

public class PythonAiException extends RuntimeException {

    public PythonAiException(String message) {
        super(message);
    }

    public PythonAiException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

---

### ğŸŒ 3. WebClient ì‚¬ìš© ì˜ˆì œ (Spring WebFlux)

#### PythonAiWebClient.java

```java
package com.oathkeeper.service;

import com.oathkeeper.dto.request.GroupSummaryRequest;
import com.oathkeeper.dto.request.GroupTextSummaryRequest;
import com.oathkeeper.dto.response.GroupSummaryResponse;
import com.oathkeeper.dto.response.GroupTextSummaryResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class PythonAiWebClient {

    private final WebClient.Builder webClientBuilder;

    @Value("${python.ai.base-url:http://localhost:8001}")
    private String pythonAiBaseUrl;

    /**
     * ê·¸ë£¹ í†µê³„ ìš”ì•½ ì¡°íšŒ (ë¹„ë™ê¸°)
     */
    public Mono<GroupSummaryResponse> getGroupSummaryAsync(List<Long> planIds) {
        GroupSummaryRequest request = GroupSummaryRequest.builder()
                .planIds(planIds)
                .build();

        return webClientBuilder.build()
                .post()
                .uri(pythonAiBaseUrl + "/metrics/group/summary")
                .bodyValue(request)
                .retrieve()
                .onStatus(
                        status -> status == HttpStatus.CONFLICT,
                        response -> Mono.error(new PythonAiException("ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"))
                )
                .bodyToMono(GroupSummaryResponse.class)
                .doOnSuccess(response -> {
                    if (response.getWarnings() != null && !response.getWarnings().isEmpty()) {
                        log.warn("ê·¸ë£¹ ìš”ì•½ ì¡°íšŒ ì‹œ ê²½ê³ : {}", response.getWarnings());
                    }
                })
                .doOnError(error -> log.error("ê·¸ë£¹ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨: planIds={}", planIds, error));
    }

    /**
     * ê·¸ë£¹ ìì—°ì–´ ìš”ì•½ ì¡°íšŒ (ë¹„ë™ê¸°)
     */
    public Mono<GroupTextSummaryResponse> getGroupSummaryTextAsync(
            List<Long> planIds,
            String style,
            String notes,
            String mode
    ) {
        GroupTextSummaryRequest request = GroupTextSummaryRequest.builder()
                .planIds(planIds)
                .style(style != null ? style : "")
                .notes(notes != null ? notes : "")
                .mode(mode != null ? mode : "llm")
                .build();

        return webClientBuilder.build()
                .post()
                .uri(pythonAiBaseUrl + "/metrics/group/summary/text")
                .bodyValue(request)
                .retrieve()
                .onStatus(
                        status -> status == HttpStatus.CONFLICT,
                        response -> Mono.error(new PythonAiException("ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"))
                )
                .bodyToMono(GroupTextSummaryResponse.class)
                .doOnSuccess(response -> {
                    if (response.getWarnings() != null && !response.getWarnings().isEmpty()) {
                        log.warn("ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì¡°íšŒ ì‹œ ê²½ê³ : {}", response.getWarnings());
                    }
                })
                .doOnError(error -> log.error("ê·¸ë£¹ í…ìŠ¤íŠ¸ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨: planIds={}", planIds, error));
    }
}
```

---

### ğŸ® 4. Controller ì‚¬ìš© ì˜ˆì œ

#### GroupMetricsController.java

```java
package com.oathkeeper.controller;

import com.oathkeeper.dto.response.GroupSummaryResponse;
import com.oathkeeper.dto.response.GroupTextSummaryResponse;
import com.oathkeeper.service.PythonAiClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/v1/groups/{groupId}/metrics")
@RequiredArgsConstructor
public class GroupMetricsController {

    private final PythonAiClient pythonAiClient;

    /**
     * ê·¸ë£¹ í†µê³„ ìš”ì•½ ì¡°íšŒ
     *
     * GET /api/v1/groups/{groupId}/metrics/summary
     */
    @GetMapping("/summary")
    public ResponseEntity<GroupSummaryResponse> getGroupSummary(
            @PathVariable Long groupId,
            @RequestParam List<Long> planIds
    ) {
        log.info("ê·¸ë£¹ í†µê³„ ìš”ì•½ ì¡°íšŒ: groupId={}, planIds={}", groupId, planIds);

        GroupSummaryResponse response = pythonAiClient.getGroupSummary(planIds);

        return ResponseEntity.ok(response);
    }

    /**
     * ê·¸ë£¹ ìì—°ì–´ ìš”ì•½ ì¡°íšŒ
     *
     * GET /api/v1/groups/{groupId}/metrics/summary/text
     */
    @GetMapping("/summary/text")
    public ResponseEntity<String> getGroupSummaryText(
            @PathVariable Long groupId,
            @RequestParam List<Long> planIds,
            @RequestParam(required = false) String style,
            @RequestParam(required = false) String notes,
            @RequestParam(defaultValue = "rules") String mode
    ) {
        log.info("ê·¸ë£¹ ìì—°ì–´ ìš”ì•½ ì¡°íšŒ: groupId={}, planIds={}, mode={}", groupId, planIds, mode);

        GroupTextSummaryResponse response = pythonAiClient.getGroupSummaryText(
                planIds, style, notes, mode
        );

        return ResponseEntity.ok(response.getData());
    }
}
```

---

### ğŸ“‹ 5. ì‹¤ì œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì±„íŒ…ë°© í†µê³„ í˜ì´ì§€

```java
@Service
@RequiredArgsConstructor
public class ChatRoomService {

    private final PythonAiClient pythonAiClient;
    private final PlanRepository planRepository;

    /**
     * ì±„íŒ…ë°©ì˜ ì „ì²´ ì•½ì† í†µê³„ ì¡°íšŒ
     */
    public ChatRoomStatistics getChatRoomStatistics(Long chatRoomId) {
        // 1. í•´ë‹¹ ì±„íŒ…ë°©ì˜ ëª¨ë“  plan_id ì¡°íšŒ
        List<Long> planIds = planRepository.findAllByChatRoomId(chatRoomId)
                .stream()
                .map(Plan::getId)
                .collect(Collectors.toList());

        if (planIds.isEmpty()) {
            throw new BusinessException("ì±„íŒ…ë°©ì— ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤");
        }

        // 2. Python AI ì„œë²„ì—ì„œ ê·¸ë£¹ í†µê³„ ì¡°íšŒ
        GroupSummaryResponse response = pythonAiClient.getGroupSummary(planIds);

        // 3. DTO ë³€í™˜
        return ChatRoomStatistics.from(response.getData());
    }

    /**
     * ì±„íŒ…ë°© í™œë™ ìš”ì•½ í…ìŠ¤íŠ¸ ìƒì„±
     */
    public String getChatRoomActivitySummary(Long chatRoomId) {
        List<Long> planIds = planRepository.findAllByChatRoomId(chatRoomId)
                .stream()
                .map(Plan::getId)
                .collect(Collectors.toList());

        if (planIds.isEmpty()) {
            return "ì•„ì§ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.";
        }

        // LLM ëª¨ë“œë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ìš”ì•½ ìƒì„±
        GroupTextSummaryResponse response = pythonAiClient.getGroupSummaryText(
                planIds,
                "ì¹œê·¼í•œ í†¤ìœ¼ë¡œ",
                "ê¸ì •ì ì¸ ë©´ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”",
                "llm"
        );

        return response.getData();
    }
}
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ í†µê³„ ì—…ë°ì´íŠ¸

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class ChatRoomStatisticsScheduler {

    private final PythonAiClient pythonAiClient;
    private final ChatRoomRepository chatRoomRepository;
    private final ChatRoomStatisticsRepository statisticsRepository;

    /**
     * ë§¤ì¼ ìì •ì— ëª¨ë“  ì±„íŒ…ë°©ì˜ í†µê³„ ì—…ë°ì´íŠ¸
     */
    @Scheduled(cron = "0 0 0 * * *")
    public void updateAllChatRoomStatistics() {
        log.info("ì±„íŒ…ë°© í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘");

        List<ChatRoom> chatRooms = chatRoomRepository.findAll();

        for (ChatRoom chatRoom : chatRooms) {
            try {
                updateChatRoomStatistics(chatRoom);
            } catch (Exception e) {
                log.error("ì±„íŒ…ë°© í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: chatRoomId={}", chatRoom.getId(), e);
            }
        }

        log.info("ì±„íŒ…ë°© í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì´ {}ê°œ", chatRooms.size());
    }

    private void updateChatRoomStatistics(ChatRoom chatRoom) {
        List<Long> planIds = chatRoom.getPlans()
                .stream()
                .map(Plan::getId)
                .collect(Collectors.toList());

        if (planIds.isEmpty()) {
            return;
        }

        // Python AI ì„œë²„ì—ì„œ í†µê³„ ì¡°íšŒ
        GroupSummaryResponse response = pythonAiClient.getGroupSummary(planIds);

        // DBì— ì €ì¥
        ChatRoomStatistics statistics = ChatRoomStatistics.builder()
                .chatRoomId(chatRoom.getId())
                .totalPlans(response.getData().getTotalPlansAnalyzed())
                .totalRecords(response.getData().getTotalRecords())
                .totalDistanceKm(response.getData().getTotalDistanceKm())
                .avgDistancePerPlanKm(response.getData().getAvgDistancePerPlanKm())
                .totalLateMinutes(response.getData().getTotalLateMinutes())
                .avgLateMinutesPerPlan(response.getData().getAvgLateMinutesPerPlan())
                .updatedAt(LocalDateTime.now())
                .build();

        statisticsRepository.save(statistics);
    }
}
```

---

### âš™ï¸ 6. Configuration

#### RestTemplateConfig.java

```java
package com.oathkeeper.config;

import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.ClientHttpRequestFactory;
import org.springframework.http.client.SimpleClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;

import java.time.Duration;

@Configuration
public class RestTemplateConfig {

    @Bean
    public RestTemplate restTemplate(RestTemplateBuilder builder) {
        return builder
                .setConnectTimeout(Duration.ofSeconds(5))
                .setReadTimeout(Duration.ofSeconds(30))  // LLM ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ê³ ë ¤
                .requestFactory(this::clientHttpRequestFactory)
                .build();
    }

    private ClientHttpRequestFactory clientHttpRequestFactory() {
        SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
        factory.setConnectTimeout(5000);
        factory.setReadTimeout(30000);
        return factory;
    }
}
```

#### application.yml

```yaml
python:
  ai:
    base-url: http://localhost:8001
    # ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ Python AI ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½
    # base-url: http://python-ai-server:8001
```

---

### ğŸ” 7. ì—ëŸ¬ ì²˜ë¦¬ Best Practices

#### GlobalExceptionHandler.java

```java
package com.oathkeeper.exception;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(PythonAiException.class)
    public ResponseEntity<ErrorResponse> handlePythonAiException(PythonAiException e) {
        log.error("Python AI ì„œë²„ ì˜¤ë¥˜", e);

        ErrorResponse response = ErrorResponse.builder()
                .code("PYTHON_AI_ERROR")
                .message(e.getMessage())
                .build();

        return ResponseEntity
                .status(HttpStatus.SERVICE_UNAVAILABLE)
                .body(response);
    }
}
```

---

### ğŸ“Š 8. ì‘ë‹µ ì˜ˆì œ (ì‹¤ì œ ë°ì´í„°)

#### ì •ìƒ ì‘ë‹µ

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 4,
    "total_records": 128,
    "total_distance_km": 258.4,
    "avg_distance_per_plan_km": 64.6,
    "total_travel_minutes": 450,
    "avg_travel_minutes_per_plan": 112.5,
    "total_late_minutes": 45,
    "avg_late_minutes_per_plan": 11.25,
    "total_wait_minutes": 20,
    "avg_wait_minutes_per_plan": 5.0
  },
  "warnings": null
}
```

#### ë¶€ë¶„ ì‹¤íŒ¨ ì‘ë‹µ (warnings í¬í•¨)

```json
{
  "success": true,
  "data": {
    "total_plans_analyzed": 3,
    "total_records": 96,
    "total_distance_km": 193.8,
    "avg_distance_per_plan_km": 64.6,
    "total_travel_minutes": 337,
    "avg_travel_minutes_per_plan": 112.33,
    "total_late_minutes": 34,
    "avg_late_minutes_per_plan": 11.33,
    "total_wait_minutes": 15,
    "avg_wait_minutes_per_plan": 5.0
  },
  "warnings": [
    "plan_id '15' was not found.",
    "plan_id '23' has no metrics data."
  ]
}
```

#### ì™„ì „ ì‹¤íŒ¨ ì‘ë‹µ (409 Conflict)

```json
{
  "detail": {
    "code": "NO_DATA",
    "message": "No data available for the given plan_ids."
  }
}
```

---

### ï¿½ 9. ì£¼ìš” ì²´í¬í¬ì¸íŠ¸

#### âœ… í•„ìˆ˜ í™•ì¸ ì‚¬í•­

1. **Python AI ì„œë²„ ì—°ê²°**

   - `application.yml`ì˜ `python.ai.base-url` ì„¤ì • í™•ì¸
   - ë„¤íŠ¸ì›Œí¬ ì—°ê²° ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

2. **Timeout ì„¤ì •**

   - LLM ëª¨ë“œ ì‚¬ìš© ì‹œ ìµœì†Œ 30ì´ˆ ì´ìƒ ê¶Œì¥
   - `rules` ëª¨ë“œëŠ” 1~2ì´ˆ ë‚´ ì‘ë‹µ

3. **ì—ëŸ¬ ì²˜ë¦¬**

   - 409 Conflict: ëª¨ë“  plan_id ì‹¤íŒ¨ â†’ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
   - warnings: ì¼ë¶€ ì‹¤íŒ¨ â†’ ë¡œê·¸ ê¸°ë¡, ì„œë¹„ìŠ¤ ê³„ì†

4. **ì„±ëŠ¥ ê³ ë ¤**
   - plan_ids ê°œìˆ˜: 100ê°œ ì´í•˜ ê¶Œì¥
   - ëŒ€ëŸ‰ ì¡°íšŒ ì‹œ ë¹„ë™ê¸° ì²˜ë¦¬ ê³ ë ¤

#### âš ï¸ ì£¼ì˜ì‚¬í•­

1. **snake_case â†” camelCase ë³€í™˜**

   - Python: `total_distance_km`
   - Java: `totalDistanceKm`
   - `@JsonProperty` ì–´ë…¸í…Œì´ì…˜ í•„ìˆ˜!

2. **null ì²˜ë¦¬**

   - `warnings`ëŠ” null ê°€ëŠ¥
   - `style`, `notes`ëŠ” ë¹ˆ ë¬¸ìì—´ ê¸°ë³¸ê°’

3. **íƒ€ì… ë§¤ì¹­**

## âœ… ì‘ì—… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: í•µì‹¬ ê¸°ëŠ¥ âœ…

- [x] Pydantic ëª¨ë¸ ì¶”ê°€ (`models.py`)
- [x] ê·¸ë£¹ ìš”ì•½ ì„œë¹„ìŠ¤ ë¡œì§ (`group_service.py` ì‹ ê·œ)
- [x] ê·¸ë£¹ ìš”ì•½ ë¼ìš°í„° (`group.py` ì‹ ê·œ)
- [x] ë©”ì¸ ì•± í†µí•© (`main.py`)
- [x] ì—ëŸ¬ ì²˜ë¦¬ êµ¬í˜„ (ë¶€ë¶„ ì„±ê³µ + ì™„ì „ ì‹¤íŒ¨)
- [x] LLM í†µí•© (Ollama + fallback)
- [x] í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [x] ì‘ì—… ê¸°ë¡ ë¬¸ì„œí™”

### Phase 2: í…ŒìŠ¤íŠ¸ & ê²€ì¦ (ê¶Œì¥)

- [ ] Swagger UI ìˆ˜ë™ í…ŒìŠ¤íŠ¸
- [ ] Spring íŒ€ í”¼ë“œë°± ìˆ˜ë ´
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

---

**ì‘ì—… ì™„ë£Œì¼:** 2025-11-24  
**ì‘ì—… ì‹œê°„:** ì•½ 1ì‹œê°„  
**ì‘ì—… ìƒíƒœ:** âœ… Phase 1 ì™„ë£Œ, í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ  
**ë‹¤ìŒ ì‘ì—…ì:** Spring ì„œë²„ ê°œë°œíŒ€ (í†µí•© í…ŒìŠ¤íŠ¸)
